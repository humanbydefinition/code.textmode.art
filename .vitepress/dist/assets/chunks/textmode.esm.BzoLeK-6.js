var ht=Object.defineProperty,at=(a,t,e)=>t in a?ht(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e,h=(a,t,e)=>at(a,typeof t!="symbol"?t+"":t,e);class C extends Error{constructor(t,e={}){super(C.i(t,e)),this.name="TextmodeError"}static i(t,e){return`${t}${e&&Object.keys(e).length>0?`

ðŸ“‹ Context:`+Object.entries(e).map(([s,i])=>`
  - ${s}: ${C.o(i)}`).join(""):""}

${"â†“".repeat(24)}
`}static o(t){if(t===null)return"null";if(t===void 0)return"undefined";if(typeof t=="string")return`"${t}"`;if(typeof t=="number"||typeof t=="boolean")return t+"";if(Array.isArray(t))return t.length===0?"[]":t.length<=5?`[${t.map(e=>C.o(e)).join(", ")}]`:`[${t.slice(0,3).map(e=>C.o(e)).join(", ")}, ... +${t.length-3} more]`;if(typeof t=="object"){const e=Object.keys(t);return e.length===0?"{}":e.length<=3?`{ ${e.map(s=>`${s}: ${C.o(t[s])}`).join(", ")} }`:`{ ${e.slice(0,2).map(s=>`${s}: ${C.o(t[s])}`).join(", ")}, ... +${e.length-2} more }`}return t+""}}var lt=(a=>(a[a.SILENT=0]="SILENT",a[a.WARNING=1]="WARNING",a[a.ERROR=2]="ERROR",a[a.THROW=3]="THROW",a))(lt||{});const tt=class B{constructor(){h(this,"u",{globalLevel:3})}static _(){return B.l||(B.l=new B),B.l}m(t,e){const s="%c[textmode.js] Oops! (â•¯Â°â–¡Â°)â•¯ï¸µ Something went wrong in your code.",i="color: #f44336; font-weight: bold; background: #ffebee; padding: 2px 6px; border-radius: 3px;";switch(this.u.globalLevel){case 0:return!1;case 1:return console.group(s,i),console.warn(C.i(t,e)),console.groupEnd(),!1;case 2:return console.group(s,i),console.error(C.i(t,e)),console.groupEnd(),!1;default:throw new C(t,e)}}v(t,e,s){return!!t||(this.m(e,s),!1)}A(t){this.u.globalLevel=t}};h(tt,"l",null);let ct=tt;const z=ct._(),et=new WeakMap;function Y(a,t){et.set(a,t)}function W(a){return et.get(a)}class st{constructor(){h(this,"C",1),h(this,"M",0),h(this,"U",0),h(this,"F",0),h(this,"R",[0,0,0]),h(this,"P",[1,1,1,1]),h(this,"S",[0,0,0,1]),h(this,"$",!1),h(this,"D",!1),h(this,"k",!1),h(this,"L",[0,0]),h(this,"O",[0,0,0,1]),h(this,"H",[])}G(){this.H.push({I:this.C,N:this.M,X:this.U,W:this.F,L:[...this.L],K:this.$,j:this.D,k:this.k,Y:[...this.R],V:[...this.P],q:[...this.S]})}Z(){const t=this.H.pop();t?(this.C=t.I,this.M=t.N,this.U=t.X,this.F=t.W,this.L=t.L,this.$=t.K,this.D=t.j,this.k=t.k,this.R=t.Y,this.P=t.V,this.S=t.q):console.warn("pop() called without matching push()")}J(t){t.I=this.C,t.N=this.M,t.X=this.U,t.W=this.F,t.Y[0]=this.R[0],t.Y[1]=this.R[1],t.Y[2]=this.R[2],t.V[0]=this.P[0],t.V[1]=this.P[1],t.V[2]=this.P[2],t.V[3]=this.P[3],t.q[0]=this.S[0],t.q[1]=this.S[1],t.q[2]=this.S[2],t.q[3]=this.S[3],t.K=this.$,t.j=this.D,t.k=this.k,t.L[0]=this.L[0],t.L[1]=this.L[1]}get lineWeight(){return this.C}get canvasBackgroundColor(){return this.O}tt(t){this.C=Math.abs(t)}st(t){this.M=t}et(t){this.U=t}it(t){this.F=t}rt(t){this.R=t}nt(t,e,s,i=255){this.P=[t/255,e/255,s/255,i/255]}ot(t,e,s,i=255){this.S=[t/255,e/255,s/255,i/255]}ht(t){this.$=t}ct(t){this.D=t}lt(t){this.k=t}ut(t){const e=255*t/360,s=Math.floor(e)/255,i=Math.round(e-Math.floor(e));this.L=[s,i]}ft(t,e,s,i){this.O=[t/255,e/255,s/255,i/255]}}class K{constructor(t,e,s=e,i=1,r={},n=null,o=!1){h(this,"dt"),h(this,"_t"),h(this,"u"),h(this,"vt",null),h(this,"gt"),h(this,"At"),h(this,"yt",[]),h(this,"wt"),h(this,"Ct",null),h(this,"bt",[]),h(this,"xt",null),h(this,"Mt",!1),h(this,"Ft",null),this.dt=e,this._t=s,this.u={filter:"nearest",wrap:"clamp",format:"rgba",type:"unsigned_byte",...r},this.gt=t,this.wt=Math.min(Math.max(1,i),8),this.xt=n,this.Mt=!!o,this.Ft=this.Mt?new st:null;const l=t.getParameter(t.MAX_DRAW_BUFFERS),c=t.getParameter(t.MAX_COLOR_ATTACHMENTS);this.wt=Math.min(this.wt,l,c),this.At=t.createFramebuffer(),this.zt(),this.Rt(),this.bt=Array(this.wt).fill(null)}zt(){const t=this.gt,e=this.u.filter==="linear"?t.LINEAR:t.NEAREST,s=this.u.wrap==="repeat"?t.REPEAT:t.CLAMP_TO_EDGE,i=this.u.type==="float"?t.FLOAT:t.UNSIGNED_BYTE;for(let r=0;r<this.wt;r++){const n=t.createTexture();t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,s),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,this.dt,this._t,0,t.RGBA,i,null),this.yt.push(n)}t.bindTexture(t.TEXTURE_2D,null)}Rt(){const t=this.gt;if(t.bindFramebuffer(t.FRAMEBUFFER,this.At),this.wt===1)t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.yt[0],0);else{const s=[];for(let i=0;i<this.wt;i++){const r=t.COLOR_ATTACHMENT0+i;t.framebufferTexture2D(t.FRAMEBUFFER,r,t.TEXTURE_2D,this.yt[i],0),s.push(r)}t.drawBuffers(s)}const e=t.checkFramebufferStatus(t.FRAMEBUFFER);e!==t.FRAMEBUFFER_COMPLETE&&console.error("GLFramebuffer is not complete:",e),t.bindFramebuffer(t.FRAMEBUFFER,null)}Tt(t){const e=this.gt;e.bindTexture(e.TEXTURE_2D,this.yt[0]),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),e.bindTexture(e.TEXTURE_2D,null)}resize(t,e){this.dt=t,this._t=e,this.vt=null,this.bt=Array(this.wt).fill(null);const s=this.gt,i=this.u.type==="float"?s.FLOAT:s.UNSIGNED_BYTE;for(const r of this.yt)s.bindTexture(s.TEXTURE_2D,r),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,this.dt,this._t,0,s.RGBA,i,null);s.bindTexture(s.TEXTURE_2D,null)}readPixels(t){const e=this.gt,s=this.bt[t];if(s)return s;const i=this.dt,r=this._t,n=new Uint8Array(i*r*4),o=e.getParameter(e.READ_FRAMEBUFFER_BINDING);e.bindFramebuffer(e.READ_FRAMEBUFFER,this.At),e.readBuffer(e.COLOR_ATTACHMENT0+t),e.readPixels(0,0,i,r,e.RGBA,e.UNSIGNED_BYTE,n),e.bindFramebuffer(e.READ_FRAMEBUFFER,o);const l=4*i,c=new Uint8Array(n.length);for(let g=0;g<r;g++){const f=(r-1-g)*l,m=g*l;c.set(n.subarray(f,f+l),m)}return this.bt[t]=c,c}begin(){var t,e,s,i;const r=this.gt;if(this.xt){const n=((e=(t=this.xt).Pt)==null?void 0:e.call(t))??null;n&&this.xt.St(n),this.Mt&&this.Ft&&((i=(s=this.xt).$t)==null||i.call(s,this.Ft))}this.Ct={framebuffer:r.getParameter(r.FRAMEBUFFER_BINDING),viewport:r.getParameter(r.VIEWPORT)},r.bindFramebuffer(r.FRAMEBUFFER,this.At),this.bt=Array(this.wt).fill(null);for(let n=0;n<this.wt;n++)r.clearBufferfv(r.COLOR,n,new Float32Array([0,0,0,0]));r.viewport(0,0,this.dt,this._t),Y(r,[0,0,this.dt,this._t])}end(){var t,e,s,i;if(!this.Ct)return;const r=this.gt;if(this.xt){const n=((e=(t=this.xt).Pt)==null?void 0:e.call(t))??null;n&&this.xt.St(n)}r.bindFramebuffer(r.FRAMEBUFFER,this.Ct.framebuffer),r.viewport(...this.Ct.viewport),Y(r,this.Ct.viewport),this.Ct=null,this.xt&&this.Mt&&this.Ft&&((i=(s=this.xt).Et)==null||i.call(s))}Dt(){const t=this.gt;t.deleteFramebuffer(this.At);for(const e of this.yt)t.deleteTexture(e)}get width(){return this.dt}get height(){return this._t}get textures(){return[...this.yt]}}class M{constructor(t,e,s){h(this,"gt"),h(this,"kt"),h(this,"Bt",new Map),h(this,"Lt",new Map),h(this,"Ot",0),this.gt=t,this.kt=this.Ht(e,s),this.Gt()}Gt(){const t=this.gt.getProgramParameter(this.kt,this.gt.ACTIVE_UNIFORMS);for(let e=0;e<t;e++){const s=this.gt.getActiveUniform(this.kt,e);if(s){const i=this.gt.getUniformLocation(this.kt,s.name);if(i&&(this.Bt.set(s.name,i),this.Lt.set(s.name,{type:s.type,size:s.size}),s.size>1)){const r=s.name.replace(/\[.*\]$/,"");this.Bt.has(r)||(this.Bt.set(r,i),this.Lt.set(r,{type:s.type,size:s.size}))}}}}Ht(t,e){const s=this.It(this.gt.VERTEX_SHADER,t),i=this.It(this.gt.FRAGMENT_SHADER,e),r=this.gt.createProgram();if(this.gt.attachShader(r,s),this.gt.attachShader(r,i),this.gt.linkProgram(r),!this.gt.getProgramParameter(r,this.gt.LINK_STATUS)){const n=this.gt.getProgramInfoLog(r);throw Error("Shader program link error: "+n)}return this.gt.deleteShader(s),this.gt.deleteShader(i),r}It(t,e){const s=this.gt.createShader(t);if(this.gt.shaderSource(s,e),this.gt.compileShader(s),!this.gt.getShaderParameter(s,this.gt.COMPILE_STATUS)){const i=this.gt.getShaderInfoLog(s);throw this.gt.deleteShader(s),Error("Shader compilation error: "+i)}return s}Nt(){this.gt.useProgram(this.kt),this.Xt()}Xt(){this.Ot=0}Wt(t){for(const[e,s]of Object.entries(t))this.Kt(e,s)}jt(t){return this.Bt.has(t)}Yt(t){return this.Lt.get(t)||null}Vt(){const t=[];for(const[e,s]of this.Lt.entries())t.push({name:e,...s});return t}Kt(t,e){var s;const i=this.Bt.get(t);if(!i)return;const r=this.Lt.get(t);if(!r)return void console.warn(`No type information found for uniform '${t}'`);const{type:n,size:o}=r,l=this.gt;if(typeof e=="number")switch(n){case l.INT:case l.BOOL:l.uniform1i(i,e);break;case l.FLOAT:l.uniform1f(i,e);break;default:console.warn(`Unexpected uniform type for scalar '${t}': ${n}`),l.uniform1f(i,e)}else if(typeof e=="boolean")l.uniform1i(i,e?1:0);else if(Array.isArray(e))if(Array.isArray(e[0])){const c=e,g=((s=c[0])==null?void 0:s.length)||0,f=c.flat();switch(n){case l.FLOAT_VEC2:g===2?l.uniform2fv(i,f):console.warn(`Vector length mismatch for '${t}': expected 2, got ${g}`);break;case l.FLOAT_VEC3:g===3?l.uniform3fv(i,f):console.warn(`Vector length mismatch for '${t}': expected 3, got ${g}`);break;case l.FLOAT_VEC4:g===4?l.uniform4fv(i,f):console.warn(`Vector length mismatch for '${t}': expected 4, got ${g}`);break;default:console.warn(`Unsupported uniform type for vector array '${t}': ${n}`)}}else switch(n){case l.FLOAT_VEC2:e.length===2?l.uniform2f(i,e[0],e[1]):console.warn(`Vector length mismatch for '${t}': expected 2, got ${e.length}`);break;case l.FLOAT_VEC3:e.length===3?l.uniform3f(i,e[0],e[1],e[2]):console.warn(`Vector length mismatch for '${t}': expected 3, got ${e.length}`);break;case l.FLOAT_VEC4:e.length===4?l.uniform4f(i,e[0],e[1],e[2],e[3]):console.warn(`Vector length mismatch for '${t}': expected 4, got ${e.length}`);break;case l.INT:o>1?l.uniform1iv(i,e):console.warn(`Array provided for scalar uniform '${t}'`);break;case l.FLOAT:o>1?l.uniform1fv(i,e):console.warn(`Array provided for scalar uniform '${t}'`);break;default:console.warn(`Unsupported uniform type for array '${t}': ${n}`)}else if(e instanceof WebGLTexture){const c=this.qt();l.uniform1i(i,c),l.activeTexture(l.TEXTURE0+c),l.bindTexture(l.TEXTURE_2D,e)}else if(e instanceof K){const c=this.qt();l.uniform1i(i,c),l.activeTexture(l.TEXTURE0+c),l.bindTexture(l.TEXTURE_2D,e.textures[0])}else console.warn(`Unsupported uniform type for '${t}':`,typeof e)}qt(){return this.Ot++}get Zt(){return this.kt}Dt(){this.gt.deleteProgram(this.kt)}}const G=`#version 300 es
in vec2 a_position;in vec2 a_texCoord;in vec2 a_instancePosition;in vec2 a_instanceSize;in vec3 a_instanceCharacter;in vec4 a_instancePrimaryColor;in vec4 a_instanceSecondaryColor;in vec2 a_instanceRotation;in vec3 a_instanceTransform;in vec3 a_instanceGlobalRotation;in vec2 a_instanceRotationCenter;in vec2 a_instanceBezierCP1;in vec2 a_instanceBezierCP2;in vec2 a_instanceBezierStart;in vec2 a_instanceBezierEnd;in vec2 a_instanceArcAngles;uniform float U9;uniform vec2 Uw;out vec2 v_uv;out vec3 v_character;out vec4 v_primaryColor;out vec4 v_secondaryColor;out vec2 v_rotation;out vec3 v_transform;mat3 A(float B){float C=sin(B),D=cos(B);return mat3(1,0,0,0,D,-C,0,C,D);}mat3 E(float B){float C=sin(B),D=cos(B);return mat3(D,0,C,0,1,0,-C,0,D);}mat3 F(float B){float C=sin(B),D=cos(B);return mat3(D,-C,0,C,D,0,0,0,1);}vec2 G(float H,vec2 I,vec2 J,vec2 K,vec2 L){float M=1.-H,N=M*M,O=H*H;return N*M*I+3.*N*H*J+3.*M*O*K+O*H*L;}vec2 P(float H,vec2 I,vec2 J,vec2 K,vec2 L){float M=1.-H,N=M*M,O=H*H;return-3.*N*I+3.*N*J-6.*M*H*J+6.*M*H*K-3.*O*K+3.*O*L;}void main(){v_uv=a_texCoord;v_character=a_instanceCharacter;v_primaryColor=a_instancePrimaryColor;v_secondaryColor=a_instanceSecondaryColor;v_rotation=a_instanceRotation;v_transform=a_instanceTransform;vec2 Q;bool R=length(a_instanceBezierCP1)+length(a_instanceBezierCP2)+length(a_instanceBezierStart)+length(a_instanceBezierEnd)>0.;bool S=a_instanceArcAngles.x!=0.||a_instanceArcAngles.y!=0.;if(R){float H=a_position.x;vec2 T=G(H,a_instanceBezierStart,a_instanceBezierCP1,a_instanceBezierCP2,a_instanceBezierEnd);vec2 U=P(H,a_instanceBezierStart,a_instanceBezierCP1,a_instanceBezierCP2,a_instanceBezierEnd);float V=length(U);U=V>0.?U/V:vec2(1,0);Q=T+vec2(-U.y,U.x)*a_position.y*a_instanceSize.y;}else if(S){float C=a_instanceArcAngles.x,W=a_instanceArcAngles.y;C=mod(C,6.28318530718);if(C<0.)C+=6.28318530718;W=mod(W,6.28318530718);if(W<0.)W+=6.28318530718;float X=C-W;if(X<=0.)X+=6.28318530718;float Y=C-a_position.x*X;vec2 Z=vec2(cos(Y),sin(Y))*a_position.y;Q=Z*a_instanceSize*.5+a_instanceSize*.5+a_instancePosition;}else{Q=a_position*a_instanceSize+a_instancePosition;}vec2 a=(Q/Uw)*2.-1.;a.y=-a.y;if(length(a_instanceGlobalRotation)>0.){vec3 b=vec3(a-a_instanceRotationCenter,0);b.x*=U9;if(a_instanceGlobalRotation.x!=0.)b=A(-a_instanceGlobalRotation.x)*b;if(a_instanceGlobalRotation.y!=0.)b=E(-a_instanceGlobalRotation.y)*b;if(a_instanceGlobalRotation.z!=0.)b=F(-a_instanceGlobalRotation.z)*b;b.x/=U9;a=b.xy+a_instanceRotationCenter;}gl_Position=vec4(a,0,1);}`,it="attribute vec2 a_position;attribute vec2 a_texCoord;varying vec2 v_uv;void main(){v_uv=a_texCoord;gl_Position=vec4(a_position,0.,1.);}";class ut{constructor(t){h(this,"gt"),h(this,"Qt"),h(this,"Jt"),h(this,"ts"),h(this,"ss"),this.gt=t,this.Jt=new M(this.gt,G,`#version 300 es
precision highp float;in vec2 v_uv;in vec3 v_character;in vec4 v_primaryColor;in vec4 v_secondaryColor;in vec2 v_rotation;in vec3 v_transform;layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 o_rotation;layout(location=4)out vec4 o_transform;void main(){o_character=vec4(v_character,1.);o_primaryColor=v_primaryColor;o_secondaryColor=v_secondaryColor;o_rotation=vec4(v_rotation,0.,1.);o_transform=vec4(v_transform,1.);}`),this.Qt=new M(this.gt,G,`#version 300 es
precision highp float;in vec2 v_uv;uniform sampler2D Ue;uniform sampler2D Uf;uniform sampler2D Ug;uniform sampler2D Uh;uniform sampler2D Ui;uniform vec2 Uj;layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 o_rotation;layout(location=4)out vec4 o_transform;void main(){vec2 A=vec2(v_uv.x,1.-v_uv.y);vec2 B=A*Uj;vec2 C=(floor(B)+0.5f)/Uj;vec4 D=texture(Ue,C);vec4 E=texture(Uf,C);if(E.a==0.){discard;}vec4 F=texture(Ug,C);vec4 G=texture(Uh,C);vec4 H=texture(Ui,C);o_character=D;o_primaryColor=E;o_secondaryColor=F;o_rotation=G;o_transform=H;}`),this.ts=new M(this.gt,it,"precision mediump float;uniform sampler2D U0;uniform vec2 U1;uniform sampler2D U3;uniform sampler2D U4;uniform sampler2D U5;uniform sampler2D U2;uniform sampler2D U6;uniform vec2 U7;uniform vec2 U8;mat2 A(float B){float C=sin(B);float D=cos(B);return mat2(D,-C,C,D);}void main(){vec2 E=gl_FragCoord.xy/U8;vec2 F=E*U7;vec2 G=floor(F);vec2 H=(G+0.5)/U7;vec4 I=texture2D(U3,H);vec4 J=texture2D(U4,H);vec4 K=texture2D(U5,H);bool L=K.r>0.5;bool M=K.g>0.5;bool N=K.b>0.5;vec4 O=texture2D(U2,H);int P=int(O.r*255.+0.5)+int(O.g*255.+0.5)*256;int Q=int(mod(float(P),U1.x));int R=P/int(U1.x);float S=(U1.y-1.)-float(R);vec2 T=vec2(float(Q),S)/U1;vec4 U=texture2D(U6,H);float V=U.r*255.+U.g;float W=-(V*360./255.)*0.017453292;vec2 X=fract(F)-0.5;if(M)X.x=-X.x;if(N)X.y=-X.y;X=A(W)*X+0.5;vec2 Y=1./U1;vec2 Z=T+X*Y;vec2 a=T+Y;if(any(lessThan(Z,T))||any(greaterThan(Z,a))){gl_FragColor=L?I:J;return;}vec4 b=texture2D(U0,Z);if(L)b.rgb=1.-b.rgb;gl_FragColor=mix(J,I,b);}"),this.ss=new M(this.gt,G,`#version 300 es
precision highp float;in vec2 v_uv;uniform sampler2D Uk;uniform bool Ul;uniform bool Um;uniform bool Un;uniform vec2 Uo;uniform bool Up;uniform vec4 Uq;uniform bool Ur;uniform vec4 Us;uniform vec4 Ut;uniform int Uu;uniform vec3 Uv[64];layout(location=0)out vec4 o_character;layout(location=1)out vec4 o_primaryColor;layout(location=2)out vec4 o_secondaryColor;layout(location=3)out vec4 o_rotation;layout(location=4)out vec4 o_transform;float A(vec3 B){return dot(B,vec3(0.299f,0.587f,0.114f));}void main(){vec2 C=vec2(v_uv.x,1.0f-v_uv.y);vec4 D=texture(Uk,C);float E=A(D.rgb);if(Uu>0){float F=float(Uu);float G=clamp(E*(F-1.0f),0.0f,F-1.0f);int H=int(floor(G+0.5f));vec3 I=Uv[H];o_character=vec4(I,1.0f);}else{o_character=vec4(E,0.0f,0.0f,1.0f);}vec4 J=Up?Uq:D;vec4 K=Ur?Us:D;if(D.a<0.01f){J=Ut;K=Ut;}else{}o_primaryColor=vec4(J);o_secondaryColor=vec4(K);o_rotation=vec4(Uo.xy,0.0f,1.0f);o_transform=vec4(float(Ul),float(Um),float(Un),1.0f);}`)}es(){return this.Qt}Pt(){return this.Jt}rs(){return this.ts}ns(){return this.ss}hs(t){return new M(this.gt,G,t)}cs(t,e){return new M(this.gt,t,e)}Dt(){this.Qt.Dt(),this.Jt.Dt(),this.ts.Dt(),this.ss.Dt()}}var w=(a=>(a.RECTANGLE="rectangle",a.LINE="line",a.ELLIPSE="ellipse",a.ARC="arc",a.TRIANGLE="triangle",a.BEZIER_CURVE="bezier_curve",a.CUSTOM="custom",a))(w||{});class ft{constructor(t){h(this,"gt"),h(this,"ls",new Map),this.gt=t}us(t,e,s,i){const r=this.gt;let n=this.ls.get(t);n||(n=new Map,this.ls.set(t,n));let o=n.get(e)||null;if(!o){o=r.createVertexArray(),n.set(e,o),r.bindVertexArray(o),r.bindBuffer(r.ARRAY_BUFFER,i);const l=r.getAttribLocation(t,"a_position");l!==-1&&(r.enableVertexAttribArray(l),r.vertexAttribPointer(l,s.ds.fs.size,r.FLOAT,!1,s.ps,s.ds.fs.offset),r.vertexAttribDivisor(l,0));const c=r.getAttribLocation(t,"a_texCoord");c!==-1&&(r.enableVertexAttribArray(c),r.vertexAttribPointer(c,s.ds._s.size,r.FLOAT,!1,s.ps,s.ds._s.offset),r.vertexAttribDivisor(c,0))}r.bindVertexArray(o)}vs(){this.gt.bindVertexArray(null)}Dt(){for(const[,t]of this.ls)for(const[,e]of t)e&&this.gt.deleteVertexArray(e)}}class dt{constructor(t,e){h(this,"gs"),h(this,"gt"),h(this,"xt"),h(this,"As",null),h(this,"ws",null),this.gt=t,this.gs=new ft(t),this.xt=e}Cs(t,e,s){const{shader:i}=t,r=W(this.gt)||this.gt.getParameter(this.gt.VIEWPORT);i.Wt({U9:r[2]/r[3],Uw:[r[2],r[3]]});const n=c=>{if(!c||!c.bs())return;const g=c.unitGeometry,f=c.unitBuffer;try{this.gs.us(i.Zt,c.type+"",g,f),c.batch.Ms(i),c.batch.Fs(g.zs,g.Rs)}finally{c.batch.Ts(i),this.gs.vs(),c.Ps()}};let o=null,l=null;for(const c of e){if(c.type===w.CUSTOM){l&&(n(l),o=null,l=null),this.Ss(t,c.params,c.state,s.get(w.RECTANGLE));continue}o!==null&&c.type!==o&&(n(l),o=null,l=null);let g=l;g&&c.type===o||(g=s.get(c.type)||null,l=g,o=c.type),g&&g.$s(c.params,c.state)}n(l)}Ss(t,e,s,i){const{x:r,y:n,width:o,height:l,shader:c,uniforms:g}=e,f=this.Es(Math.max(1,Math.floor(o)),Math.max(1,Math.floor(l)));f.begin(),this.Ds(i,c,g,0,0,f.width,f.height,{}),f.end();const m=this.ks(),p={Ue:f.textures[0],Uf:f.textures[1],Ug:f.textures[2],Uh:f.textures[3],Ui:f.textures[4],Uj:[f.width,f.height]};this.Ds(i,m,p,Math.floor(r),Math.floor(n),Math.max(1,Math.floor(o)),Math.max(1,Math.floor(l)),s),t.shader.Nt()}Ds(t,e,s,i,r,n,o,l){e.Nt(),e.Wt(s);const c=this.gt.getParameter(this.gt.VIEWPORT);if(e.Wt({U9:c[2]/c[3],Uw:[c[2],c[3]]}),t.Ps(),t.$s({x:i,y:r,width:n,height:o},l),t.bs()){const g=t.unitGeometry,f=t.unitBuffer;try{this.gs.us(e.Zt,t.type+"",g,f),t.batch.Ms(e),t.batch.Fs(g.zs,g.Rs)}finally{t.batch.Ts(e),this.gs.vs(),t.Ps()}}}ks(){return this.xt.es()}Es(t,e){return this.As&&this.ws&&this.ws.w===t&&this.ws.h===e||(this.As&&this.As.Dt(),this.As=new K(this.gt,t,e,5),this.ws={w:t,h:e}),this.As}Dt(){this.gs.Dt(),this.As&&this.As.Dt()}}class gt{constructor(){h(this,"Bs",[]),h(this,"Ls",1),h(this,"Os",0)}Hs(t){if(this.Os>=this.Bs.length){const s={id:this.Ls++,type:t,params:{},state:{I:1,N:0,X:0,W:0,Y:[0,0,0],V:[1,1,1,1],q:[0,0,0,1],K:!1,j:!1,k:!1,L:[0,0]}};this.Bs.push(s)}const e=this.Bs[this.Os];return e.id=this.Ls++,e.type=t,this.Os++,e}Gs(t,e,s,i,r){const n=this.Hs(w.RECTANGLE);return n.params.x=t,n.params.y=e,n.params.width=s,n.params.height=i,r.J(n.state),n.id}Is(t,e,s,i,r,n,o){const l=this.Hs(w.CUSTOM);return l.params.x=t,l.params.y=e,l.params.width=s,l.params.height=i,l.params.shader=r,l.params.uniforms=n,o.J(l.state),l.id}Ns(t,e,s,i,r,n){const o=this.Hs(w.LINE);return o.params.x1=t,o.params.y1=e,o.params.x2=s,o.params.y2=i,o.params.thickness=r,n.J(o.state),o.id}Xs(t,e,s,i,r){const n=this.Hs(w.ELLIPSE);return n.params.x=t,n.params.y=e,n.params.width=s,n.params.height=i,r.J(n.state),n.id}Ws(t,e,s,i,r,n,o){const l=this.Hs(w.ARC);return l.params.x=t,l.params.y=e,l.params.width=s,l.params.height=i,l.params.start=r,l.params.stop=n,o.J(l.state),l.id}Ks(t,e,s,i,r,n,o){const l=this.Hs(w.TRIANGLE);return l.params.x1=t,l.params.y1=e,l.params.x2=s,l.params.y2=i,l.params.x3=r,l.params.y3=n,o.J(l.state),l.id}js(t,e,s,i,r,n,o,l,c,g){const f=this.Hs(w.BEZIER_CURVE);return f.params.x1=t,f.params.y1=e,f.params.cp1x=s,f.params.cp1y=i,f.params.cp2x=r,f.params.cp2y=n,f.params.x2=o,f.params.y2=l,f.params.thickness=c,g.J(f.state),f.id}get length(){return this.Os}get isEmpty(){return this.Os===0}Ys(){this.Os=0}[Symbol.iterator](){let t=0;const e=this.Os,s=this.Bs;return{next:()=>t<e?{value:s[t++],done:!1}:{value:void 0,done:!0}}}}const q=class I{static Vs(t,e,s=0){var i,r,n,o,l,c,g,f,m,p;const d=e||new Float32Array(I.FLOATS_PER_INSTANCE);let u=s;return d[u++]=t.fs[0],d[u++]=t.fs[1],d[u++]=t.Os[0],d[u++]=t.Os[1],d[u++]=t.Y[0],d[u++]=t.Y[1],d[u++]=t.Y[2],d[u++]=t.V[0],d[u++]=t.V[1],d[u++]=t.V[2],d[u++]=t.V[3],d[u++]=t.q[0],d[u++]=t.q[1],d[u++]=t.q[2],d[u++]=t.q[3],d[u++]=t.L[0],d[u++]=t.L[1],d[u++]=t.qs[0],d[u++]=t.qs[1],d[u++]=t.qs[2],d[u++]=t.N,d[u++]=t.X,d[u++]=t.W,d[u++]=t.Zs[0],d[u++]=t.Zs[1],d[u++]=((i=t.Qs)==null?void 0:i[0])||0,d[u++]=((r=t.Qs)==null?void 0:r[1])||0,d[u++]=((n=t.Js)==null?void 0:n[0])||0,d[u++]=((o=t.Js)==null?void 0:o[1])||0,d[u++]=((l=t.te)==null?void 0:l[0])||0,d[u++]=((c=t.te)==null?void 0:c[1])||0,d[u++]=((g=t.se)==null?void 0:g[0])||0,d[u++]=((f=t.se)==null?void 0:f[1])||0,d[u++]=((m=t.ee)==null?void 0:m[0])||0,d[u++]=((p=t.ee)==null?void 0:p[1])||0,d}static ie(t){const e=t.length*I.FLOATS_PER_INSTANCE,s=new Float32Array(e);for(let i=0;i<t.length;i++){const r=i*I.FLOATS_PER_INSTANCE;I.Vs(t[i],s,r)}return s}};h(q,"BYTES_PER_INSTANCE",140),h(q,"FLOATS_PER_INSTANCE",35);let N=q;const b=class{};h(b,"STRIDE",N.BYTES_PER_INSTANCE),h(b,"ATTRIBUTES",{a_instancePosition:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:b.STRIDE,offset:0,divisor:1},a_instanceSize:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:b.STRIDE,offset:8,divisor:1},a_instanceCharacter:{location:-1,size:3,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:b.STRIDE,offset:16,divisor:1},a_instancePrimaryColor:{location:-1,size:4,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:b.STRIDE,offset:28,divisor:1},a_instanceSecondaryColor:{location:-1,size:4,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:b.STRIDE,offset:44,divisor:1},a_instanceRotation:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:b.STRIDE,offset:60,divisor:1},a_instanceTransform:{location:-1,size:3,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:b.STRIDE,offset:68,divisor:1},a_instanceGlobalRotation:{location:-1,size:3,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:b.STRIDE,offset:80,divisor:1},a_instanceRotationCenter:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:b.STRIDE,offset:92,divisor:1},a_instanceArcAngles:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:b.STRIDE,offset:100,divisor:1},a_instanceBezierCP1:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:b.STRIDE,offset:108,divisor:1},a_instanceBezierCP2:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:b.STRIDE,offset:116,divisor:1},a_instanceBezierStart:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:b.STRIDE,offset:124,divisor:1},a_instanceBezierEnd:{location:-1,size:2,type:WebGL2RenderingContext.FLOAT,normalized:!1,stride:b.STRIDE,offset:132,divisor:1}});let Q=b;class mt{constructor(t,e=1e3,s=1.5){h(this,"gt"),h(this,"re",[]),h(this,"ne"),h(this,"oe"),h(this,"he",null),h(this,"ae",!0),h(this,"ce",0),h(this,"le",new Map),h(this,"ue",null),this.gt=t,this.ne=e,this.oe=s,this.fe()}$s(t){const e=this.re.length;return this.re.push(t),this.ae=!0,e}get count(){return this.re.length}get isEmpty(){return this.re.length===0}clear(){this.re.length=0,this.ae=!0}de(t){if(t<=this.ne)return;const e=Math.ceil(t*this.oe);this.ne=e,this.fe()}fe(){const t=this.gt;this.he&&t.deleteBuffer(this.he),this.he=t.createBuffer();const e=this.ne*N.BYTES_PER_INSTANCE;t.bindBuffer(t.ARRAY_BUFFER,this.he),t.bufferData(t.ARRAY_BUFFER,e,t.DYNAMIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.ae=!0,this.ce=0}pe(){if(!this.ae||this.re.length===0)return;const t=this.gt,e=this.re.length;this.de(e),(!this.ue||this.ue.length<e*N.FLOATS_PER_INSTANCE)&&(this.ue=new Float32Array(e*N.FLOATS_PER_INSTANCE));const s=N.ie(this.re);t.bindBuffer(t.ARRAY_BUFFER,this.he),e<=this.ce?t.bufferSubData(t.ARRAY_BUFFER,0,s):t.bufferData(t.ARRAY_BUFFER,s,t.DYNAMIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),this.ae=!1,this.ce=e}_e(t){let e=this.le.get(t);if(!e){e=new Map;const s=this.gt;for(const i in Q.ATTRIBUTES){const r=s.getAttribLocation(t,i);r!==-1&&e.set(i,r)}this.le.set(t,e)}return e}Ms(t){if(!this.he||this.re.length===0)return;const e=this.gt,s=t.Zt;this.pe();const i=this._e(s);e.bindBuffer(e.ARRAY_BUFFER,this.he);for(const[r,n]of i){const o=Q.ATTRIBUTES[r];o&&(e.enableVertexAttribArray(n),e.vertexAttribPointer(n,o.size,o.type,o.normalized,o.stride,o.offset),e.vertexAttribDivisor(n,o.divisor))}}Ts(t){const e=this.gt,s=this._e(t.Zt);for(const[,i]of s)e.disableVertexAttribArray(i),e.vertexAttribDivisor(i,0)}Fs(t,e){this.re.length!==0&&this.gt.drawArraysInstanced(t,0,e,this.re.length)}Dt(){this.he&&this.gt.deleteBuffer(this.he)}}class L{constructor(t,e,s,i){h(this,"gt"),h(this,"me"),h(this,"ve"),h(this,"ge"),h(this,"Ae",null),this.gt=t,this.me=e,this.ve=s,this.ge=i;const r=this.gt.createBuffer();if(!r)throw Error("Failed to create unit geometry buffer");this.gt.bindBuffer(this.gt.ARRAY_BUFFER,r),this.gt.bufferData(this.gt.ARRAY_BUFFER,this.ge.ye,this.gt.STATIC_DRAW),this.gt.bindBuffer(this.gt.ARRAY_BUFFER,null),this.Ae=r}get type(){return this.ve}get unitGeometry(){return this.ge}get unitBuffer(){return this.Ae}get batch(){return this.me}Ps(){this.me.clear()}bs(){return!this.me.isEmpty}Dt(){this.me.Dt(),this.gt.deleteBuffer(this.Ae)}we(t,e,s,i,r){const n=this.Ce(t,e,s,i,r.N||0,r.X||0,r.W||0);return{fs:[t,e],Os:[s,i],Y:r.Y||[0,0,0],V:r.V||[1,1,1,1],q:r.q||[0,0,0,1],L:r.L||[0,0],qs:[r.k?1:0,r.K?1:0,r.j?1:0],N:n.radiansX,X:n.radiansY,W:n.radiansZ,Zs:[n.centerX,n.centerY]}}be(t,e){const s=W(this.gt)||[0,0,this.gt.canvas.width,this.gt.canvas.height];return{nx:t/s[2]*2-1,ny:1-e/s[3]*2}}xe(t,e,s){const i=this.be(e,s);t.Zs=[i.nx,i.ny]}Ce(t,e,s,i,r,n,o){const l=W(this.gt)||[0,0,this.gt.canvas.width,this.gt.canvas.height],c=l[2],g=l[3];return{centerX:(t+s/2)/c*2-1,centerY:1-(e+i/2)/g*2,radiansX:-r*Math.PI/180,radiansY:-n*Math.PI/180,radiansZ:-o*Math.PI/180,aspectRatio:c/g}}}const At={ye:new Float32Array([0,0,0,0,1,0,1,0,0,1,0,1,0,1,0,1,1,0,1,0,1,1,1,1]),Rs:6,zs:WebGL2RenderingContext.TRIANGLES,ps:16,ds:{fs:{size:2,offset:0},_s:{size:2,offset:8}}};class pt extends L{constructor(t,e){super(t,e,w.RECTANGLE,At)}$s(t,e){const s=this.we(t.x,t.y,t.width,t.height,e);return this.me.$s(s)}}const vt={ye:new Float32Array([0,-.5,0,0,1,-.5,1,0,0,.5,0,1,0,.5,0,1,1,-.5,1,0,1,.5,1,1]),Rs:6,zs:WebGL2RenderingContext.TRIANGLES,ps:16,ds:{fs:{size:2,offset:0},_s:{size:2,offset:8}}};class yt extends L{constructor(t,e){super(t,e,w.LINE,vt)}$s(t,e){const s=t.x2-t.x1,i=t.y2-t.y1,r=Math.hypot(s,i),n=t.thickness||e.I||1,o=t.x1+s/2,l=t.y1+i/2,c=o-r/2,g=l,f=this.we(c,g,r,n,e);return this.xe(f,o,l),this.me.$s(f)}}const wt={ye:function(a=32){const t=[],e=2*Math.PI/a;for(let s=0;s<a;s++){const i=s*e,r=(s+1)%a*e,n=Math.cos(i),o=Math.sin(i),l=.5*(n+1),c=.5*(o+1),g=Math.cos(r),f=Math.sin(r),m=.5*(g+1),p=.5*(f+1);t.push(0,0,.5,.5,n,o,l,c,g,f,m,p)}return new Float32Array(t)}(32),Rs:96,zs:WebGL2RenderingContext.TRIANGLES,ps:16,ds:{fs:{size:2,offset:0},_s:{size:2,offset:8}}};class xt extends L{constructor(t,e){super(t,e,w.ELLIPSE,wt)}$s(t,e){const s=this.we(t.x,t.y,t.width,t.height,e);return this.xe(s,t.x,t.y),this.me.$s(s)}}let Et={ye:function(a){const t=[];for(let e=0;e<a;e++){const s=e/a,i=(e+1)/a;t.push(s,0,s,0,s,1,s,1,i,1,i,1)}return new Float32Array(t)}(32),Rs:96,zs:WebGL2RenderingContext.TRIANGLES,ps:16,ds:{fs:{size:2,offset:0},_s:{size:2,offset:8}}};class Tt extends L{constructor(t,e){super(t,e,w.ARC,Et)}$s(t,e){const s=t.x-t.width/2,i=t.y-t.height/2,r=t.start*Math.PI/180,n=t.stop*Math.PI/180,o=this.we(s,i,t.width,t.height,e);return this.xe(o,t.x,t.y),o.Qs=[r,n],this.me.$s(o)}}const Rt={ye:new Float32Array([0,0,0,0,1,0,1,0,.5,1,.5,1]),Rs:3,zs:WebGL2RenderingContext.TRIANGLES,ps:16,ds:{fs:{size:2,offset:0},_s:{size:2,offset:8}}};class bt extends L{constructor(t,e){super(t,e,w.TRIANGLE,Rt)}$s(t,e){const s=Math.min(t.x1,t.x2,t.x3),i=Math.max(t.x1,t.x2,t.x3),r=Math.min(t.y1,t.y2,t.y3),n=i-s,o=Math.max(t.y1,t.y2,t.y3)-r,l=this.we(s,r,n,o,e),c=s+.5*n,g=r+o*(1/3);return this.xe(l,c,g),this.me.$s(l)}}function J(a,t,e,s,i){const r=1-a,n=r*r,o=a*a;return n*r*t+3*n*a*e+3*r*o*s+o*a*i}const Ct={ye:function(a=16){const t=[];for(let e=0;e<a;e++){const s=e/a,i=(e+1)/a;t.push(s,-.5,s,0),t.push(i,-.5,i,0),t.push(s,.5,s,1),t.push(s,.5,s,1),t.push(i,-.5,i,0),t.push(i,.5,i,1)}return new Float32Array(t)}(16),Rs:96,zs:WebGL2RenderingContext.TRIANGLES,ps:16,ds:{fs:{size:2,offset:0},_s:{size:2,offset:8}}};class Ut extends L{constructor(t,e){super(t,e,w.BEZIER_CURVE,Ct)}$s(t,e){const s=e.I||1,i=J(.5,t.x1,t.cp1x,t.cp2x,t.x2),r=J(.5,t.y1,t.cp1y,t.cp2y,t.y2),n=this.we(0,0,1,s,e);return this.xe(n,i,r),n.se=[t.x1,t.y1],n.Js=[t.cp1x,t.cp1y],n.te=[t.cp2x,t.cp2y],n.ee=[t.x2,t.y2],this.me.$s(n)}}class Ft{constructor(t){h(this,"gt"),h(this,"Me",null),h(this,"Fe"),h(this,"ze",null),h(this,"Re",{}),h(this,"Te",null),h(this,"Pe",new Map),h(this,"Se"),h(this,"$e"),h(this,"Ee"),h(this,"H",[]),this.gt=t,this.Fe=new ut(t),this.Ee=new st,this.Se=new dt(t,this),this.$e=new gt,this.Te=t.createBuffer(),Y(this.gt,[0,0,this.gt.canvas.width,this.gt.canvas.height])}De(t){let e=this.Pe.get(t);if(e)return e;const s=new mt(this.gt);return e=(0,{[w.RECTANGLE]:()=>new pt(this.gt,s),[w.LINE]:()=>new yt(this.gt,s),[w.ELLIPSE]:()=>new xt(this.gt,s),[w.ARC]:()=>new Tt(this.gt,s),[w.TRIANGLE]:()=>new bt(this.gt,s),[w.BEZIER_CURVE]:()=>new Ut(this.gt,s)}[t])(),this.Pe.set(t,e),e}ke(t){this.Me!==t&&(this.Me=t,t.Nt())}cs(t,e){return this.Fe.cs(t,e)}es(){return this.Fe.es()}Pt(){return this.Fe.Pt()}rs(){return this.Fe.rs()}ns(){return this.Fe.ns()}Be(t){this.ze=t,t&&(this.Re={})}Kt(t,e){this.Re[t]=e}Le(t){Object.assign(this.Re,t)}hs(t){return this.Fe.hs(t)}Oe(t,e,s,i,r){const n=this.es(),o={Ue:t.textures[0],Uf:t.textures[1],Ug:t.textures[2],Uh:t.textures[3],Ui:t.textures[4],Uj:[t.width,t.height]};this.$e.Is(e,s,i,r,n,o,this.Ee)}He(t,e,s,i,r){const n=this.ns(),o=t.Ge(),l={Uk:o.texture,Ul:!!o.invert,Um:!!o.flipX,Un:!!o.flipY,Uo:o.charRotation,Up:o.charColorFixed,Uq:o.charColor,Ur:o.cellColorFixed,Us:o.cellColor,Ut:o.backgroundColor,Uu:o.charCount,Uv:o.charList};this.$e.Is(e,s,i,r,n,l,this.Ee)}Ie(t,e,s,i){var r;const n=this.gt,o=n.canvas.width,l=n.canvas.height,c=t/o*2-1,g=(t+s)/o*2-1,f=1-e/l*2,m=1-(e+i)/l*2,p=new Float32Array([c,m,g,m,c,f,g,m,g,f,c,f]);n.bindBuffer(n.ARRAY_BUFFER,this.Te),n.bufferData(n.ARRAY_BUFFER,p,n.DYNAMIC_DRAW);const d=((r=this.Me)==null?void 0:r.Zt)||n.getParameter(n.CURRENT_PROGRAM),u=d?n.getAttribLocation(d,"a_position"):-1;u!==-1&&(n.enableVertexAttribArray(u),n.vertexAttribPointer(u,2,n.FLOAT,!1,8,0)),n.drawArrays(n.TRIANGLES,0,6),u!==-1&&n.disableVertexAttribArray(u)}Ne(t,e,s,i){this.ze?(this.$e.Is(t,e,s,i,this.ze,{...this.Re},this.Ee),this.ze=null,this.Re={}):this.$e.Gs(t,e,s,i,this.Ee)}Xe(t,e,s,i){this.$e.Ns(t,e,s,i,this.Ee.lineWeight,this.Ee)}We(t,e,s,i){this.$e.Xs(t,e,s,i,this.Ee)}Ke(t,e,s,i,r,n){this.$e.Ks(t,e,s,i,r,n,this.Ee)}je(t,e,s,i,r,n,o,l){const c=this.Ee.lineWeight;this.$e.js(t,e,s,i,r,n,o,l,c,this.Ee)}Ye(t,e,s=1,i={}){return new K(this.gt,t,e,s,i,this,!0)}Ve(t,e,s,i,r,n){this.$e.Ws(t,e,s,i,r,n,this.Ee)}qe(t,e=t,s=t,i=255){this.Ee.ft(t,e,s,i),this.Ys(t/255,e/255,s/255,i/255)}Ys(t=0,e=0,s=0,i=0){this.gt.clearColor(t,e,s,i),this.gt.clear(this.gt.COLOR_BUFFER_BIT)}Ze(){this.gt.viewport(0,0,this.gt.canvas.width,this.gt.canvas.height),Y(this.gt,[0,0,this.gt.canvas.width,this.gt.canvas.height])}get context(){return this.gt}get state(){return this.Ee}$t(t){this.H.push(this.Ee),this.Ee=t}Et(){const t=this.H.pop();t&&(this.Ee=t)}St(t){const e=t,s=W(this.gt)??this.gt.getParameter(this.gt.VIEWPORT),i={shader:e,gl:this.gt,viewport:s};this.ke(e);const r=new Set;for(const n of this.$e)n.type===w.CUSTOM?r.add(w.RECTANGLE):r.add(n.type);for(const n of r)n!==w.CUSTOM&&this.De(n);this.Se.Cs(i,this.$e,this.Pe),this.$e.Ys()}Dt(){this.gt.deleteBuffer(this.Te),this.$e.Ys();for(const t of this.Pe.values())t.Dt();this.Fe.Dt(),this.Se.Dt()}}const E={readShort:(a,t)=>(E.t.uint16[0]=a[t]<<8|a[t+1],E.t.int16[0]),readUshort:(a,t)=>a[t]<<8|a[t+1],readUshorts(a,t,e){const s=[];for(let i=0;i<e;i++)s.push(E.readUshort(a,t+2*i));return s},readUint(a,t){const e=E.t.uint8;return e[3]=a[t],e[2]=a[t+1],e[1]=a[t+2],e[0]=a[t+3],E.t.uint32[0]},readASCII(a,t,e){let s="";for(let i=0;i<e;i++)s+=String.fromCharCode(a[t+i]);return s},writeUshort(a,t,e){a[t]=e>>>8&255,a[t+1]=255&e},writeUint(a,t,e){a[t]=e>>>24&255,a[t+1]=e>>>16&255,a[t+2]=e>>>8&255,a[t+3]=255&e},writeASCII(a,t,e){for(let s=0;s<e.length;s++)a[t+s]=255&e.charCodeAt(s)},t:(()=>{const a=new ArrayBuffer(8);return{uint8:new Uint8Array(a),int16:new Int16Array(a),uint16:new Uint16Array(a),uint32:new Uint32Array(a)}})()};function X(a){return a+3&-4}function k(a,t,e){const s=t+e;let i=0;const r=E.t;for(let n=t;n<s;n+=4)r.uint8[3]=a[n]||0,r.uint8[2]=a[n+1]||0,r.uint8[1]=a[n+2]||0,r.uint8[0]=a[n+3]||0,i=i+(r.uint32[0]>>>0)>>>0;return i>>>0}class Pt{constructor(t){h(this,"b"),h(this,"p",0),h(this,"bitbuf",0),h(this,"bitcnt",0),this.b=t}readBits(t){for(;this.bitcnt<t;){const s=this.b[this.p++]||0;this.bitbuf|=s<<this.bitcnt,this.bitcnt+=8}const e=this.bitbuf&(1<<t)-1;return this.bitbuf>>>=t,this.bitcnt-=t,e}alignToByte(){this.bitbuf=0,this.bitcnt=0}get offset(){return this.p}}function S(a){let t=32,e=0;for(const o of a)o&&(o<t&&(t=o),o>e&&(e=o));if(e===0)return{min:0,max:0,table:new Map};const s=new Uint32Array(e+1);for(const o of a)o&&s[o]++;const i=new Uint32Array(e+1);let r=0;s[0]=0;for(let o=1;o<=e;o++)r=r+s[o-1]<<1,i[o]=r;const n=new Map;for(let o=0;o<a.length;o++){const l=a[o];if(!l)continue;const c=i[l]++;let g=n.get(l);g||(g=[],n.set(l,g)),g[Ot(c,l)]=o}return{min:t,max:e,table:n}}function V(a,t){let e=0;for(let s=1;s<=t.max;s++){e|=a.readBits(1)<<s-1;const i=t.table.get(s);if(i&&e<i.length){const r=i[e];if(r!==void 0)return r}}throw Error("Invalid Huffman code")}function Ot(a,t){let e=0;for(let s=0;s<t;s++)e=e<<1|1&a,a>>>=1;return e>>>0}function _t(a){if(a.length<2)throw Error("ZLIB data too short");const t=a[0],e=a[1];if((15&t)!=8)throw Error("Unsupported ZLIB compression method");if(((t<<8)+e)%31!=0)throw Error("Bad ZLIB header check");let s=2;32&e&&(s+=4);const i=[];return function(r,n){const o=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258],l=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],c=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],g=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13];let f=0;for(;!f;){f=r.readBits(1);const m=r.readBits(2);if(m===0){r.alignToByte();const p=r.readBits(16);if((65535&(65535^p))!==r.readBits(16))throw Error("DEFLATE uncompressed LEN/NLEN mismatch");for(let d=0;d<p;d++)n.push(r.readBits(8))}else{if(m!==1&&m!==2)throw Error("Unsupported DEFLATE type");{let p,d;if(m===1){const u=Array(288).fill(0);for(let v=0;v<=143;v++)u[v]=8;for(let v=144;v<=255;v++)u[v]=9;for(let v=256;v<=279;v++)u[v]=7;for(let v=280;v<=287;v++)u[v]=8;p=S(u),d=S(Array(32).fill(5))}else{const u=r.readBits(5)+257,v=r.readBits(5)+1,A=r.readBits(4)+4,x=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],y=Array(19).fill(0);for(let F=0;F<A;F++)y[x[F]]=r.readBits(3);const U=S(y),T=[];for(;T.length<u+v;){const F=V(r,U);if(F<=15)T.push(F);else if(F===16){const D=r.readBits(2)+3,_=T[T.length-1]||0;for(let Z=0;Z<D;Z++)T.push(_)}else if(F===17){const D=r.readBits(3)+3;for(let _=0;_<D;_++)T.push(0)}else{if(F!==18)throw Error("Invalid code length symbol");{const D=r.readBits(7)+11;for(let _=0;_<D;_++)T.push(0)}}}const R=T.slice(0,u),P=T.slice(u,u+v);p=S(R),d=S(P)}for(;;){const u=V(r,p);if(u<256)n.push(u);else{if(u===256)break;if(u>256&&u<286){const v=u-257;let A=o[v];const x=l[v];x&&(A+=r.readBits(x));const y=V(r,d);if(y>=30)throw Error("Invalid distance symbol");let U=c[y];const T=g[y];T&&(U+=r.readBits(T));const R=n.length-U;if(R<0)throw Error("Invalid distance");for(let P=0;P<A;P++)n.push(n[R+P]||0)}else if(u===286||u===287)throw Error("Reserved length symbol")}}}}}}(new Pt(a.subarray(s)),i),new Uint8Array(i)}function Mt(a){const t=E,e=new Uint8Array(a);if(t.readASCII(e,0,4)!=="wOFF")throw Error("Invalid WOFF signature");const s=t.readUint(e,4),i=t.readUshort(e,12),r=t.readUint(e,16),n=[];let o=44;for(let A=0;A<i;A++){const x=t.readASCII(e,o,4),y=t.readUint(e,o+4),U=t.readUint(e,o+8),T=t.readUint(e,o+12),R=t.readUint(e,o+16);n.push({tag:x,offset:y,compLength:U,origLength:T,checksum:R}),o+=20}for(const A of n){const x=new Uint8Array(e.buffer,A.offset,A.compLength);if(A.compLength===A.origLength)A.data=new Uint8Array(x);else if(A.data=_t(x),A.data.length!==A.origLength)if(A.data.length<A.origLength){const y=new Uint8Array(A.origLength);y.set(A.data),A.data=y}else A.data=A.data.subarray(0,A.origLength)}const l=i;let c=1,g=0;for(;c<<1<=l;)c<<=1,g++;const f=16*c,m=16*l-f;let p=12+16*l;const d={};for(const A of n)d[A.tag]=p,p=X(p+A.data.length);const u=new Uint8Array(Math.max(r||0,p));t.writeUint(u,0,s),t.writeUshort(u,4,l),t.writeUshort(u,6,f),t.writeUshort(u,8,g),t.writeUshort(u,10,m);let v=12;for(const A of n){t.writeASCII(u,v,A.tag),v+=4;let x=A.data;if(A.tag==="head"&&x.length>=12){const y=new Uint8Array(x);t.writeUint(y,8,0);const U=k(y,0,X(y.length));t.writeUint(u,v,U),v+=4}else{const y=k(x,0,X(x.length));t.writeUint(u,v,y),v+=4}t.writeUint(u,v,d[A.tag]),v+=4,t.writeUint(u,v,A.data.length),v+=4}for(const A of n){const x=d[A.tag];u.set(A.data,x)}if(n.find(A=>A.tag==="head")){const A=d.head,x=function(y,U){const T=E,R=U+8,P=[y[R],y[R+1],y[R+2],y[R+3]];T.writeUint(y,R,0);const F=2981146554-(k(y,0,X(y.length))>>>0)>>>0;return y[R]=P[0],y[R+1]=P[1],y[R+2]=P[2],y[R+3]=P[3],F>>>0}(u,A);t.writeUint(u,A+8,x)}return u.buffer}const Lt={parseTab(a,t,e){const s={tables:[],ids:{},off:t};a=new Uint8Array(a.buffer,t,e),t=0;const i=E,r=i.readUshort,n=r(a,t+=2);t+=2;const o=[];for(let l=0;l<n;l++){const c=r(a,t),g=r(a,t+=2);t+=2;const f=i.readUint(a,t);t+=4;const m=`p${c}e${g}`;let p=o.indexOf(f);if(p===-1){let d;p=s.tables.length,o.push(f);const u=r(a,f);d=u===4?this.parse4(a,f):u===12?this.parse12(a,f):{format:u},s.tables.push(d)}s.ids[m]=p}return s},parse4(a,t){const e=E,s=e.readUshort,i=e.readUshorts,r=t,n=s(a,t+=2);t+=2;const o=s(a,t+=2)>>>1,l={format:4,searchRange:s(a,t+=2),entrySelector:0,rangeShift:0,endCount:[],startCount:[],idDelta:[],idRangeOffset:[],glyphIdArray:[]};t+=2,l.entrySelector=s(a,t),t+=2,l.rangeShift=s(a,t),t+=2,l.endCount=i(a,t,o),t+=2*o,t+=2,l.startCount=i(a,t,o),t+=2*o;for(let c=0;c<o;c++)l.idDelta.push(e.readShort(a,t)),t+=2;return l.idRangeOffset=i(a,t,o),t+=2*o,l.glyphIdArray=i(a,t,r+n-t>>1),l},parse12(a,t){const e=E.readUint;e(a,t+=4),e(a,t+=4);const s=e(a,t+=4);t+=4;const i=new Uint32Array(3*s);for(let r=0;r<3*s;r+=3)i[r]=e(a,t+(r<<2)),i[r+1]=e(a,t+(r<<2)+4),i[r+2]=e(a,t+(r<<2)+8);return{format:12,groups:i}}},Dt={parseTab(a,t,e){const s=E;t+=18;const i=s.readUshort(a,t);t+=2,t+=16;const r=s.readShort(a,t);t+=2;const n=s.readShort(a,t);t+=2;const o=s.readShort(a,t);t+=2;const l=s.readShort(a,t);return t+=2,t+=6,{unitsPerEm:i,xMin:r,yMin:n,xMax:o,yMax:l,indexToLocFormat:s.readShort(a,t)}}},St={parseTab(a,t,e){const s=E;t+=4;const i=["ascender","descender","lineGap","advanceWidthMax","minLeftSideBearing","minRightSideBearing","xMaxExtent","caretSlopeRise","caretSlopeRun","caretOffset","res0","res1","res2","res3","metricDataFormat","numberOfHMetrics"],r={};for(let n=0;n<i.length;n++){const o=i[n],l=o==="advanceWidthMax"||o==="numberOfHMetrics"?s.readUshort:s.readShort;r[o]=l(a,t+2*n)}return r}},Bt={parseTab(a,t,e,s){const i=E,r=[],n=[],o=s.maxp.numGlyphs,l=s.hhea.numberOfHMetrics;let c=0,g=0,f=0;for(;f<l;)c=i.readUshort(a,t+(f<<2)),g=i.readShort(a,t+(f<<2)+2),r.push(c),n.push(g),f++;for(;f<o;)r.push(c),n.push(g),f++;return{aWidth:r,lsBearing:n}}},$={cmap:Lt,head:Dt,hhea:St,maxp:{parseTab(a,t,e){const s=E;return s.readUint(a,t),t+=4,{numGlyphs:s.readUshort(a,t)}}},hmtx:Bt,loca:{parseTab(a,t,e,s){const i=E,r=[],n=s.head.indexToLocFormat,o=s.maxp.numGlyphs+1;if(n===0)for(let l=0;l<o;l++)r.push(i.readUshort(a,t+(l<<1))<<1);else if(n===1)for(let l=0;l<o;l++)r.push(i.readUint(a,t+(l<<2)));return r}},glyf:{parseTab(a,t,e,s){const i=[],r=s.maxp.numGlyphs;for(let n=0;n<r;n++)i.push(null);return i},Qe(a,t){const e=E,s=a.Je,i=a.loca;if(i[t]===i[t+1])return null;const r=O.findTable(s,"glyf",a.ti);if(!r)return null;let n=r[0]+i[t];const o={};if(o.noc=e.readShort(s,n),n+=2,o.xMin=e.readShort(s,n),n+=2,o.yMin=e.readShort(s,n),n+=2,o.xMax=e.readShort(s,n),n+=2,o.yMax=e.readShort(s,n),n+=2,o.xMin>=o.xMax||o.yMin>=o.yMax)return null;if(o.noc>0){o.endPts=[];for(let m=0;m<o.noc;m++)o.endPts.push(e.readUshort(s,n)),n+=2;const l=e.readUshort(s,n);if(n+=2,s.length-n<l)return null;n+=l;const c=o.endPts[o.noc-1]+1;o.flags=[];for(let m=0;m<c;m++){const p=s[n];if(n++,o.flags.push(p),8&p){const d=s[n];n++;for(let u=0;u<d;u++)o.flags.push(p),m++}}o.xs=[];for(let m=0;m<c;m++){const p=o.flags[m],d=!!(16&p);2&p?(o.xs.push(d?s[n]:-s[n]),n++):d?o.xs.push(0):(o.xs.push(e.readShort(s,n)),n+=2)}o.ys=[];for(let m=0;m<c;m++){const p=o.flags[m],d=!!(32&p);4&p?(o.ys.push(d?s[n]:-s[n]),n++):d?o.ys.push(0):(o.ys.push(e.readShort(s,n)),n+=2)}let g=0,f=0;for(let m=0;m<c;m++)g+=o.xs[m],f+=o.ys[m],o.xs[m]=g,o.ys[m]=f}else o.parts=[],o.endPts=[],o.flags=[],o.xs=[],o.ys=[];return o}}},O={parse(a){const t=new Uint8Array(a),e=E.readASCII(t,0,4);if(e==="wOFF")a=Mt(a);else if(e==="wOF2")throw Error("WOFF2 is not supported in this build (Brotli + WOFF2 transforms required)");return[((s,i,r,n)=>{const o=$,l={Je:s,si:i,ti:r};for(const c in o){const g=c,f=O.findTable(s,g,r);if(f){const[m,p]=f;let d=n[m];d==null&&(d=o[g].parseTab(s,m,p,l),n[m]=d),l[g]=d}}return l})(new Uint8Array(a),0,0,{})]},findTable(a,t,e){const s=E,i=s.readUshort(a,e+4);let r=e+12;for(let n=0;n<i;n++){const o=s.readASCII(a,r,4);s.readUint(a,r+4);const l=s.readUint(a,r+8),c=s.readUint(a,r+12);if(o===t)return[l,c];r+=16}return null},T:$,B:E};class It{ei(t){var e;const s=[];return(e=t.cmap)!=null&&e.tables?(t.cmap.tables.forEach(i=>{if(i.format===4){const r=this.ii(i);s.push(...r)}else if(i.format===12){const r=this.ri(i);s.push(...r)}}),[...new Set(s)]):[]}ni(t){return t.filter(e=>this.oi(e))}ii(t){const e=[];if(!(t.startCount&&t.endCount&&t.idRangeOffset&&t.idDelta))return e;for(let s=0;s<t.startCount.length;s++){const i=t.startCount[s],r=t.endCount[s];if(i!==65535||r!==65535){for(let n=i;n<=r;n++)if(this.hi(t,n,s)>0)try{const o=String.fromCodePoint(n);e.push(o)}catch{}}}return e}ri(t){const e=[];if(!t.groups)return e;for(let s=0;s<t.groups.length;s+=3){const i=t.groups[s],r=t.groups[s+1],n=t.groups[s+2];for(let o=i;o<=r;o++)if(n+(o-i)>0)try{const l=String.fromCodePoint(o);e.push(l)}catch{}}return e}hi(t,e,s){if(t.idRangeOffset[s]===0)return e+t.idDelta[s]&65535;{const i=t.idRangeOffset[s]/2+(e-t.startCount[s])-(t.startCount.length-s);if(i>=0&&t.glyphIdArray&&i<t.glyphIdArray.length){const r=t.glyphIdArray[i];if(r!==0)return r+t.idDelta[s]&65535}}return 0}oi(t){const e=t.codePointAt(0)||0;return!(e>=0&&e<=31&&e!==9&&e!==10&&e!==13||e>=127&&e<=159)}}class j{constructor(){h(this,"ai",new Map),h(this,"ci",new Map)}li(t,e){const s=`${this.ui(t)}_${e}`;if(this.ai.has(s))return this.ai.get(s);const i=t.cmap;if(!i||!i.tables)return this.ai.set(s,0),0;let r=0;for(const n of i.tables)if(n.format===4?r=this.fi(e,n):n.format===12&&(r=this.di(e,n)),r>0)break;return this.ai.set(s,r),r}pi(t,e){const s=e.codePointAt(0);return s===void 0?0:this.li(t,s)}_i(t,e){const s=t.hmtx;return s&&s.aWidth&&s.aWidth.length!==0?e<s.aWidth.length?s.aWidth[e]:s.aWidth[s.aWidth.length-1]:0}mi(t,e){const s=e/t.head.unitsPerEm,i=t.hhea.ascender*s,r=t.hhea.descender*s,n=t.hhea.lineGap*s;return{ascender:i,descender:r,lineGap:n,lineHeight:i-r+n,unitsPerEm:t.head.unitsPerEm,scale:s}}gi(){this.ai.clear(),this.ci.clear()}ui(t){return`${t.ti}_${t.Je.length}`}fi(t,e){const s=e.endCount.length;let i=-1;for(let r=0;r<s;r++)if(t<=e.endCount[r]){i=r;break}if(i===-1||t<e.startCount[i])return 0;if(e.idRangeOffset[i]===0)return t+e.idDelta[i]&65535;{const r=e.idRangeOffset[i]/2+(t-e.startCount[i])-(s-i);if(r>=0&&r<e.glyphIdArray.length){const n=e.glyphIdArray[r];return n===0?0:n+e.idDelta[i]&65535}}return 0}di(t,e){const s=e.groups.length/3;for(let i=0;i<s;i++){const r=e.groups[3*i],n=e.groups[3*i+1],o=e.groups[3*i+2];if(t>=r&&t<=n)return o+(t-r)}return 0}}class Nt{constructor(t){h(this,"Ai"),h(this,"yi"),h(this,"xt"),h(this,"wi"),this.xt=t,this.wi=new j,this.Ai=document.createElement("canvas"),this.yi=this.Ai.getContext("2d",{willReadFrequently:!0,alpha:!0})}createTextureAtlas(t,e,s,i){const r=t.length,n=Math.ceil(Math.sqrt(r)),o=Math.ceil(r/n),l=e.width*n,c=e.height*o,g=typeof i=="object"?i:null;this.Ci(l,c),this.bi(t,e,n,s,g);const f=this.xt.Ye(l,c,1,{filter:"nearest"});return f.Tt(this.Ai),{framebuffer:f,columns:n,rows:o}}Ci(t,e){this.Ai.width=t,this.Ai.height=e,this.Ai.style.width=t+"px",this.Ai.style.height=e+"px",this.yi.imageSmoothingEnabled=!1,this.Ai.style.imageRendering="pixelated",this.yi.clearRect(0,0,t,e),this.yi.textBaseline="top",this.yi.textAlign="left",this.yi.fillStyle="white"}bi(t,e,s,i,r){const n=i/r.head.unitsPerEm;for(let o=0;o<t.length;o++){const l=o%s,c=Math.floor(o/s),g=t[o].character,f=this.xi(r,g);if(!f)continue;const m=g.codePointAt(0)||0,p=this.wi.li(r,m),d=this.Mi(r,p)*n,u=l*e.width,v=c*e.height,A=u+.5*e.width,x=v+.5*e.height,y=Math.round(A-.5*e.width),U=Math.round(x-.5*i),T=y+.5*(e.width-d),R=U+r.hhea.ascender*n;this.Fi(f,T,R,n)}}xi(t,e){const s=e.codePointAt(0)||0,i=this.wi.li(t,s);if(i===0)return null;if(t.glyf&&t.glyf[i]!==null)return t.glyf[i];if(O&&O.T&&O.T.glyf){const r=O.T.glyf.Qe(t,i);return t.glyf&&r&&(t.glyf[i]=r),r}return null}Mi(t,e){const s=t.hmtx;return s&&s.aWidth?e<s.aWidth.length?s.aWidth[e]:s.aWidth[s.aWidth.length-1]:0}Fi(t,e,s,i){if(!t||!t.xs||t.noc===0)return;const{xs:r,ys:n,endPts:o,flags:l}=t;if(!(r&&n&&o&&l))return;this.yi.beginPath();let c=0;for(let g=0;g<o.length;g++){const f=o[g];if(!(f<c)){if(f>=c){const m=e+r[c]*i,p=s-n[c]*i;this.yi.moveTo(m,p);let d=c+1;for(;d<=f;)if(1&l[d]){const u=e+r[d]*i,v=s-n[d]*i;this.yi.lineTo(u,v),d++}else{const u=e+r[d]*i,v=s-n[d]*i;let A=d+1>f?c:d+1;if(1&l[A]){const x=e+r[A]*i,y=s-n[A]*i;this.yi.quadraticCurveTo(u,v,x,y),d=A+1}else{const x=(u+(e+r[A]*i))/2,y=(v+(s-n[A]*i))/2;this.yi.quadraticCurveTo(u,v,x,y),d=A}}this.yi.closePath()}c=f+1}}this.yi.fill()}}class zt{constructor(){h(this,"zi"),this.zi=new j}Ri(t,e,s){let i=0;const r=this.zi.mi(s,e),n=r.lineHeight;for(const o of t){const l=this.zi.pi(s,o);if(l===0)continue;const c=this.zi._i(s,l)*r.scale;i=Math.max(i,c)}return{width:Math.ceil(i),height:Math.ceil(n)}}gi(){this.zi.gi()}}class Ht{constructor(){h(this,"wi"),this.wi=new j}createCharacterObjects(t,e){return t.map((s,i)=>{const r=s.codePointAt(0)||0,n=this.Ti(i);let o=0;if(e.hmtx&&e.hmtx.aWidth){const l=this.wi.li(e,r);l>0&&e.hmtx.aWidth[l]!==void 0&&(o=e.hmtx.aWidth[l])}return{character:s,unicode:r,color:n,advanceWidth:o}})}Ti(t){return[t%256/255,Math.floor(t/256)%256/255,Math.floor(t/65536)%256/255]}Pi(t,e){if(!z.v(typeof t=="string","Character must be a string.",{method:"getCharacterColor",providedValue:t}))return[0,0,0];const s=e.find(i=>i.character===t);return s?s.color:[0,0,0]}Si(t,e){return z.v(typeof t=="string"&&t.length>0,"Characters must be a string with at least one character.",{method:"getCharacterColors",providedValue:t})?Array.from(t).map(s=>this.Pi(s,e)||[0,0,0]):[[0,0,0]]}}class Gt{constructor(t,e=16){h(this,"$i"),h(this,"Ei",[]),h(this,"Di"),h(this,"ki",16),h(this,"Bi",0),h(this,"Li",0),h(this,"Oi",{width:0,height:0}),h(this,"Hi"),h(this,"Gi",new Map),h(this,"Ii"),h(this,"Ni"),h(this,"Xi"),h(this,"Wi"),this.ki=e,this.Ii=new It,this.Ni=new Nt(t),this.Xi=new zt,this.Wi=new Ht}async Ki(t){let e;if(t){const s=await fetch(t);if(!s.ok)throw new C(`Failed to load font file: ${s.status} ${s.statusText}`);e=await s.arrayBuffer()}else e=await(await fetch("data:font/woff;base64,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")).arrayBuffer();await this.ji(e),this.$i=O.parse(e)[0],await this.Yi()}Vi(t){if(t===void 0)return this.ki;this.ki=t,this.Oi=this.Xi.Ri(this.Ei.map(s=>s.character),this.ki,this.$i);const e=this.Ni.createTextureAtlas(this.Ei,this.Oi,this.ki,this.$i);this.Di=e.framebuffer,this.Bi=e.columns,this.Li=e.rows}async qi(t){try{const e=await fetch(t);if(!e.ok)throw new C(`Failed to load font file: ${e.status} ${e.statusText}`);const s=await e.arrayBuffer();await this.ji(s);const i=O.parse(s);if(!i||i.length===0)throw Error("Failed to parse font file");this.$i=i[0],await this.Yi()}catch(e){throw new C("Failed to load font: "+(e instanceof Error?e.message:"Unknown error"),e)}}async ji(t){const e=Date.now();this.Hi=new FontFace("CustomFont_"+e,t),await this.Hi.load(),document.fonts.add(this.Hi)}async Yi(){const t=this.Ii.ei(this.$i),e=this.Ii.ni(t);this.Gi.clear(),this.Ei=this.Wi.createCharacterObjects(e,this.$i),this.Oi=this.Xi.Ri(e,this.ki,this.$i);const s=this.Ni.createTextureAtlas(this.Ei,this.Oi,this.ki,this.$i);this.Di=s.framebuffer,this.Bi=s.columns,this.Li=s.rows}Pi(t){return this.Wi.Pi(t,this.Ei)}Si(t){return this.Wi.Si(t,this.Ei)}getGlyphData(t){if(!Number.isFinite(t))return null;const e=this.Gi.get(t);if(e!==void 0)return e;const s=this.Zi(t);if(s<0)return this.Gi.set(t,null),null;const i=this.$i.glyf;if(!i)return this.Gi.set(t,null),null;let r=i[s]??null;return r==null&&(r=O.T.glyf.Qe(this.$i,s)??null,i[s]=r),this.Gi.set(t,r),r}Zi(t){const e=this.$i.cmap;for(const s of e.tables)if(s.format===4){const i=s;for(let r=0;r<i.startCount.length;r++)if(t>=i.startCount[r]&&t<=i.endCount[r]){if(i.idRangeOffset[r]===0)return t+i.idDelta[r]&65535;{const n=i.idRangeOffset[r]/2+(t-i.startCount[r])-(i.startCount.length-r);if(n>=0&&n<i.glyphIdArray.length){const o=i.glyphIdArray[n];if(o!==0)return o+i.idDelta[r]&65535}}}}else if(s.format===12){const i=s;for(let r=0;r<i.groups.length;r+=3){const n=i.groups[r],o=i.groups[r+1],l=i.groups[r+2];if(t>=n&&t<=o)return l+(t-n)}}return 0}Dt(){this.Di.Dt(),document.fonts.delete(this.Hi)}get fontFramebuffer(){return this.Di}get characters(){return this.Ei}get textureColumns(){return this.Bi}get textureRows(){return this.Li}get maxGlyphDimensions(){return this.Oi}get fontSize(){return this.ki}get font(){return this.$i}}class Xt{constructor(t,e,s){h(this,"Qi"),h(this,"Ji"),h(this,"dt"),h(this,"_t"),h(this,"tr"),h(this,"sr"),h(this,"er"),h(this,"ir"),h(this,"rr"),this.er=t,this.ir=e,this.rr=s,this.nr()}nr(){this.Qi=Math.floor(this.er.width/this.ir),this.Ji=Math.floor(this.er.height/this.rr),this.dt=this.Qi*this.ir,this._t=this.Ji*this.rr,this.tr=Math.floor((this.er.width-this.dt)/2),this.sr=Math.floor((this.er.height-this._t)/2)}hr(t,e){this.ir=t,this.rr=e,this.nr()}get cellWidth(){return this.ir}get cellHeight(){return this.rr}get cols(){return this.Qi}get rows(){return this.Ji}get width(){return this.dt}get height(){return this._t}get offsetX(){return this.tr}get offsetY(){return this.sr}}class Yt{constructor(t={}){h(this,"er"),h(this,"ar",null),h(this,"cr",!1),h(this,"lr"),h(this,"ur"),this.cr=t.overlay??!1,this.cr&&t.canvas?(this.ar=t.canvas,this.er=this.dr(),this.ur=!0,this.pr()):t.canvas?(this.er=t.canvas,this.ur=!1):(this.er=this._r(t.width,t.height),this.ur=!0),this.er.style.imageRendering="pixelated"}_r(t,e){const s=document.createElement("canvas");return s.className="textmodeCanvas",s.style.imageRendering="pixelated",s.width=t||800,s.height=e||600,document.body.appendChild(s),s}dr(){const t=document.createElement("canvas");t.className="textmodeCanvas",t.style.imageRendering="pixelated";const e=this.ar.getBoundingClientRect();let s=Math.round(e.width),i=Math.round(e.height);if(this.ar instanceof HTMLVideoElement){const o=this.ar;(s===0||i===0)&&o.videoWidth>0&&o.videoHeight>0&&(s=o.videoWidth,i=o.videoHeight)}t.width=s,t.height=i,t.style.position="absolute",t.style.pointerEvents="none";const r=window.getComputedStyle(this.ar);let n=parseInt(r.zIndex||"0",10);return isNaN(n)&&(n=0),t.style.zIndex=""+(n+1),t}pr(){var t;this.mr(),(t=this.ar.parentNode)==null||t.insertBefore(this.er,this.ar.nextSibling),window.ResizeObserver&&(this.lr=new ResizeObserver(()=>{this.vr()}),this.lr.observe(this.ar)),window.addEventListener("resize",()=>{this.vr()})}mr(){if(!this.ar)return;const t=this.ar.getBoundingClientRect();let e=this.ar.offsetParent;if(e&&e!==document.body){const s=e.getBoundingClientRect();this.er.style.top=t.top-s.top+"px",this.er.style.left=t.left-s.left+"px"}else this.er.style.top=t.top+window.scrollY+"px",this.er.style.left=t.left+window.scrollX+"px"}vr(t,e){if(this.cr){const s=this.ar.getBoundingClientRect();let i=Math.round(s.width),r=Math.round(s.height);if(this.ar instanceof HTMLVideoElement){const n=this.ar;(i===0||r===0)&&n.videoWidth>0&&n.videoHeight>0&&(i=n.videoWidth,r=n.videoHeight)}this.er.width=i,this.er.height=r,this.mr()}else this.er.width=t??this.er.width,this.er.height=e??this.er.height}gr(){const t=this.er.getContext("webgl2",{alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1,depth:!1,stencil:!1,powerPreference:"high-performance"});if(!t)throw new C("`textmode.js` requires WebGL2 support.");return t}Dt(){this.lr&&this.lr.disconnect();const t=this.er.getContext("webgl")||this.er.getContext("webgl2");if(t){const e=t.getExtension("WEBGL_lose_context");e&&e.loseContext()}this.ur&&this.er.parentNode&&this.er.parentNode.removeChild(this.er)}get canvas(){return this.er}get targetCanvas(){return this.ar}get width(){return this.er.width}get height(){return this.er.height}}class H{constructor(t,e,s,i){h(this,"Ar"),h(this,"dt"),h(this,"_t"),h(this,"gt"),h(this,"k",0),h(this,"K",0),h(this,"j",0),h(this,"L",[0,0]),h(this,"yr","sampled"),h(this,"wr","fixed"),h(this,"V",[1,1,1,1]),h(this,"q",[0,0,0,1]),h(this,"Cr",[0,0,0,1]),h(this,"br",[[.1,0,0]]),h(this,"Mr"),this.gt=t,this.Ar=e,this.dt=s,this._t=i}Dt(){this.gt.deleteTexture(this.Ar)}Fr(t){return typeof t=="boolean"?t?1:0:(t==null?0:Number(t))>0?1:0}invert(t=!0){return this.k=this.Fr(t),this}flipX(t=!0){return this.K=this.Fr(t),this}flipY(t=!0){return this.j=this.Fr(t),this}charRotation(t){const e=255*t/360,s=Math.floor(e)/255,i=Math.round(e-Math.floor(e));return this.L=[s,i],this}Ge(){return{texture:this.Ar,invert:this.k,flipX:this.K,flipY:this.j,charRotation:this.L,charColorFixed:this.yr==="fixed",charColor:this.V,cellColorFixed:this.wr==="fixed",cellColor:this.q,backgroundColor:this.Cr,charCount:this.br.length,charList:this.br}}charColorMode(t){return this.yr=t,this}cellColorMode(t){return this.wr=t,this}charColor(t,e,s,i){return this.V=[(t??0)/255,(e??t??0)/255,(s??t??0)/255,(i??255)/255],this}cellColor(t,e,s,i){return this.q=[(t??0)/255,(e??t??0)/255,(s??t??0)/255,(i??255)/255],this}background(t,e,s,i){return this.Cr=[(t??0)/255,(e??t??0)/255,(s??t??0)/255,(i??255)/255],this}characters(t){const e=this.Mr(t).filter(s=>Array.isArray(s)).slice(0,64);return this.br=e,this}static zr(t,e,s){const i=t.context,r=i.createTexture();i.bindTexture(i.TEXTURE_2D,r),i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,1),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,e),i.bindTexture(i.TEXTURE_2D,null);const n=e.naturalWidth??e.width??e.videoWidth??0,o=e.naturalHeight??e.height??e.videoHeight??0,l=new H(i,r,n,o);return l.Mr=s,l}get texture(){return this.Ar}get width(){return this.dt}get height(){return this._t}}class Wt{constructor(t=60){h(this,"Rr"),h(this,"Tr"),h(this,"Pr",null),h(this,"Sr",0),h(this,"$r",!0),h(this,"Er",0),h(this,"Dr",0),h(this,"kr",[]),h(this,"Br",10),h(this,"Lr",0),this.Rr=t,this.Tr=1e3/t}start(t){if(!this.$r)return;this.Sr=performance.now();const e=s=>{if(!this.$r)return void(this.Pr=null);const i=s-this.Sr;i>=this.Tr&&(t(),this.Sr=s-i%this.Tr),this.$r&&(this.Pr=requestAnimationFrame(e))};this.Pr=requestAnimationFrame(e)}stop(){this.Pr&&(cancelAnimationFrame(this.Pr),this.Pr=null)}pause(){this.$r&&(this.$r=!1,this.stop())}resume(t){this.$r||(this.$r=!0,this.start(t))}frameRate(t,e){if(t===void 0)return this.Er;this.Rr=t,this.Tr=1e3/t,this.$r&&e&&(this.stop(),this.start(e))}measureFrameRate(){const t=performance.now();if(this.Dr>0){const e=t-this.Dr;this.kr.push(e),this.kr.length>this.Br&&this.kr.shift();const s=this.kr.reduce((i,r)=>i+r,0)/this.kr.length;this.Er=1e3/s}this.Dr=t}get isLooping(){return this.$r}get frameRateLimit(){return this.Rr}get currentFrameRate(){return this.Er}get frameCount(){return this.Lr}set frameCount(t){this.Lr=t}incrementFrame(){this.Lr++}resetFrameCount(){this.Lr=0}}class rt{constructor(t){h(this,"er"),h(this,"Or"),h(this,"Hr",{x:-1,y:-1}),h(this,"Gr",{x:-1,y:-1}),h(this,"Ir",null),h(this,"Nr",0),h(this,"Xr"),h(this,"Wr"),h(this,"Kr"),h(this,"jr"),h(this,"Yr"),h(this,"Vr"),h(this,"qr",!1),h(this,"Zr"),h(this,"Qr"),h(this,"Jr"),h(this,"tn"),h(this,"sn"),this.er=t}en(t){const e=performance.now()+Math.max(0,t);e>this.Nr&&(this.Nr=e)}rn(){return performance.now()<this.Nr}nn(t){const e=this.er.canvas;e.style.cursor=t==null||t===""?"":t}Ki(t){this.Or=t,this.hn()}an(){if(this.qr)return;const t=this.er.canvas;this.Xr=e=>{this.cn(e),this.ln(e)},this.Wr=()=>{this.Gr={...this.Hr},this.Hr.x=-1,this.Hr.y=-1,this.Ir=null},this.Kr=e=>{this.cn(e),this.un(e)},this.jr=e=>{this.cn(e),this.fn(e)},this.Yr=e=>{this.cn(e),this.dn(e)},this.Vr=e=>{this.cn(e),this.pn(e)},t.addEventListener("mousemove",this.Xr,{passive:!0}),t.addEventListener("mouseleave",this.Wr,{passive:!0}),t.addEventListener("mousedown",this.Kr,{passive:!0}),t.addEventListener("mouseup",this.jr,{passive:!0}),t.addEventListener("click",this.Yr,{passive:!0}),t.addEventListener("wheel",this.Vr,{passive:!1}),this.qr=!0}_n(){if(!this.qr)return;const t=this.er.canvas;t.removeEventListener("mousemove",this.Xr),t.removeEventListener("mouseleave",this.Wr),t.removeEventListener("mousedown",this.Kr),t.removeEventListener("mouseup",this.jr),t.removeEventListener("click",this.Yr),t.removeEventListener("wheel",this.Vr),this.qr=!1}hn(){if(this.qr)try{if(this.Ir){const t=new MouseEvent("mousemove",{clientX:this.Ir.x,clientY:this.Ir.y,bubbles:!1,cancelable:!1});this.cn(t)}else this.Hr.x!==-1&&this.Hr.y!==-1&&(this.Hr.x>=this.Or.cols||this.Hr.y>=this.Or.rows)&&(this.Hr.x=-1,this.Hr.y=-1)}catch{this.Hr.x=-1,this.Hr.y=-1}}mn(t){this.Zr=t}vn(t){this.Qr=t}gn(t){this.Jr=t}An(t){this.tn=t}yn(t){this.sn=t}wn(){return{x:this.Hr.x,y:this.Hr.y}}ln(t){if(this.tn&&!this.rn()){const e={position:{...this.Hr},previousPosition:{...this.Gr},originalEvent:t};this.tn(e)}}un(t){if(this.Qr&&!this.rn()){const e={position:{...this.Hr},previousPosition:{...this.Gr},button:t.button,originalEvent:t};this.Qr(e)}}fn(t){if(this.Jr&&!this.rn()){const e={position:{...this.Hr},previousPosition:{...this.Gr},button:t.button,originalEvent:t};this.Jr(e)}}dn(t){if(this.Zr&&!this.rn()){const e={position:{...this.Hr},previousPosition:{...this.Gr},button:t.button,originalEvent:t};this.Zr(e)}}pn(t){if(this.sn&&!this.rn()){const e={position:{...this.Hr},previousPosition:{...this.Gr},delta:{x:t.deltaX,y:t.deltaY},originalEvent:t};this.sn(e)}}cn(t){const e=this.er.canvas;this.Gr={...this.Hr},this.Ir={x:t.clientX,y:t.clientY};const s=e.getBoundingClientRect(),i=t.clientX-s.left,r=t.clientY-s.top,n=e.width/s.width,o=r*(e.height/s.height),l=i*n-this.Or.offsetX,c=o-this.Or.offsetY,g=Math.floor(l/this.Or.cellWidth),f=Math.floor(c/this.Or.cellHeight);g>=0&&g<this.Or.cols&&f>=0&&f<this.Or.rows?(this.Hr.x=g,this.Hr.y=f):(this.Hr.x=-1,this.Hr.y=-1)}}const kt=Object.freeze(Object.defineProperty({__proto__:null,MouseManager:rt},Symbol.toStringTag,{value:"Module"}));class nt{constructor(){h(this,"Cn",new Map),h(this,"bn",null),h(this,"xn",null),h(this,"Mn"),h(this,"Fn"),h(this,"qr",!1),h(this,"zn"),h(this,"Rn"),h(this,"Tn",{ArrowUp:"UP_ARROW",ArrowDown:"DOWN_ARROW",ArrowLeft:"LEFT_ARROW",ArrowRight:"RIGHT_ARROW",F1:"F1",F2:"F2",F3:"F3",F4:"F4",F5:"F5",F6:"F6",F7:"F7",F8:"F8",F9:"F9",F10:"F10",F11:"F11",F12:"F12",Enter:"ENTER",Return:"RETURN",Tab:"TAB",Escape:"ESCAPE",Backspace:"BACKSPACE",Delete:"DELETE",Insert:"INSERT",Home:"HOME",End:"END",PageUp:"PAGE_UP",PageDown:"PAGE_DOWN",Shift:"SHIFT",Control:"CONTROL",Alt:"ALT",Meta:"META"," ":"SPACE"})}an(){this.qr||(this.Mn=t=>{this.Pn(t)},this.Fn=t=>{this.Sn(t)},window.addEventListener("keydown",this.Mn,{passive:!1}),window.addEventListener("keyup",this.Fn,{passive:!1}),this.qr=!0)}_n(){this.qr&&(window.removeEventListener("keydown",this.Mn),window.removeEventListener("keyup",this.Fn),this.qr=!1,this.Cn.clear(),this.bn=null,this.xn=null)}vn(t){this.zn=t}gn(t){this.Rn=t}$n(t){const e=this.En(t),s=this.Cn.get(t)||this.Cn.get(e);return(s==null?void 0:s.isPressed)||!1}Dn(){return this.bn}kn(){return this.xn}Bn(){const t=[];for(const[e,s]of this.Cn)s.isPressed&&t.push(e);return t}Ln(){return{ctrl:this.$n("Control"),shift:this.$n("Shift"),alt:this.$n("Alt"),meta:this.$n("Meta")}}On(){this.Cn.clear(),this.bn=null,this.xn=null}Pn(t){const e=t.key,s=Date.now();this.Cn.has(e)||this.Cn.set(e,{isPressed:!1,lastPressTime:0,lastReleaseTime:0});const i=this.Cn.get(e);if(!i.isPressed&&(i.isPressed=!0,i.lastPressTime=s,this.bn=e,this.zn)){const r={key:e,keyCode:t.keyCode,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey,metaKey:t.metaKey,isPressed:!0,originalEvent:t};this.zn(r)}}Sn(t){const e=t.key,s=Date.now();this.Cn.has(e)||this.Cn.set(e,{isPressed:!1,lastPressTime:0,lastReleaseTime:0});const i=this.Cn.get(e);if(i.isPressed=!1,i.lastReleaseTime=s,this.xn=e,this.Rn){const r={key:e,keyCode:t.keyCode,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey,metaKey:t.metaKey,isPressed:!1,originalEvent:t};this.Rn(r)}}En(t){return this.Tn[t]||t.toLowerCase()}}const Vt=Object.freeze(Object.defineProperty({__proto__:null,KeyboardManager:nt},Symbol.toStringTag,{value:"Module"}));class ot{constructor(t,e){h(this,"er"),h(this,"Hn"),h(this,"Or"),h(this,"Gn",new Map),h(this,"In",new Map),h(this,"Nn",new Map),h(this,"Xn",null),h(this,"Wn"),h(this,"Kn"),h(this,"jn"),h(this,"Yn"),h(this,"Vn"),h(this,"qn"),h(this,"qr",!1),h(this,"Zn"),h(this,"Qn"),h(this,"Jn"),h(this,"so"),h(this,"eo"),h(this,"io"),h(this,"ro"),h(this,"no"),h(this,"oo"),h(this,"ho"),h(this,"ao",320),h(this,"co",350),h(this,"lo",10),h(this,"uo",550),h(this,"fo",14),h(this,"do",48),h(this,"po",650),h(this,"_o",.02),h(this,"mo",2),h(this,"vo",600),h(this,"Ao",0),h(this,"yo",null),this.er=t,this.Hn=e;const s=this.er.canvas;this.Wn=s.style.touchAction,this.Kn=s.style.userSelect,s.style.touchAction||(s.style.touchAction="none"),s.style.userSelect||(s.style.userSelect="none")}Ki(t){this.Or=t,this.wo()}an(){if(this.qr)return;const t=this.er.canvas;this.jn=e=>{this.Co(e)},this.Yn=e=>{this.bo(e)},this.Vn=e=>{this.xo(e)},this.qn=e=>{this.Mo(e)},t.addEventListener("touchstart",this.jn,{passive:!1}),t.addEventListener("touchmove",this.Yn,{passive:!1}),t.addEventListener("touchend",this.Vn,{passive:!1}),t.addEventListener("touchcancel",this.qn,{passive:!1}),this.qr=!0}_n(){if(!this.qr)return;const t=this.er.canvas;t.removeEventListener("touchstart",this.jn),t.removeEventListener("touchmove",this.Yn),t.removeEventListener("touchend",this.Vn),t.removeEventListener("touchcancel",this.qn),this.qr=!1,this.Xn=null,this.Gn.clear(),this.In.clear(),this.Nn.forEach(e=>{e.longPressTimer!==null&&window.clearTimeout(e.longPressTimer)}),this.Nn.clear(),this.yo=null,this.Ao=0,t.style.touchAction=this.Wn,t.style.userSelect=this.Kn}wo(){if(!this.Or||this.Gn.size===0)return;const t=new Map;for(const e of this.Gn.values()){const s=this.Fo(e.clientX,e.clientY,e.id,e);t.set(e.id,s)}this.Gn=t}zo(){return Array.from(this.Gn.values()).map(t=>({...t}))}Ro(t){this.Zn=t}An(t){this.Qn=t}To(t){this.Jn=t}Po(t){this.so=t}So(t){this.eo=t}$o(t){this.io=t}Eo(t){this.ro=t}Do(t){this.no=t}ko(t){this.oo=t}Bo(t){this.ho=t}Co(t){var e;if(!this.Or)return;t.preventDefault(),(e=this.Hn)==null||e.en(this.vo);const s=performance.now(),i=this.Lo(t.changedTouches);for(const r of i){const n=this.Gn.get(r.id);n&&this.In.set(r.id,this.Oo(n)),this.Gn.set(r.id,r);const o={id:r.id,startPosition:r,lastPosition:r,startTime:s,lastTime:s,longPressTimer:null,longPressFired:!1};this.ro&&(o.longPressTimer=window.setTimeout(()=>{const l=this.Gn.get(r.id);l&&(o.longPressFired=!0,this.ro({touch:this.Oo(l),duration:performance.now()-o.startTime,originalEvent:t}))},this.uo)),this.Nn.set(r.id,o),this.Zn&&this.Zn(this.Ho(r,t,void 0,s))}this.Gn.size===2&&this.Go()}bo(t){var e;if(!this.Or)return;t.preventDefault(),(e=this.Hn)==null||e.en(this.vo);const s=performance.now(),i=this.Lo(t.changedTouches);for(const r of i){const n=this.Gn.get(r.id),o=n?this.Oo(n):void 0;o&&this.In.set(r.id,o),this.Gn.set(r.id,r);const l=this.Nn.get(r.id);l&&(l.lastPosition=r,l.lastTime=s,o)&&this.Io(o,r,!0)>this.fo&&l.longPressTimer!==null&&(window.clearTimeout(l.longPressTimer),l.longPressTimer=null),this.Qn&&this.Qn(this.Ho(r,t,o,s))}this.Gn.size===2?this.No(t):this.Xn=null}xo(t){if(!this.Or)return;t.preventDefault();const e=performance.now(),s=this.Lo(t.changedTouches);for(const i of s){const r=this.Gn.get(i.id),n=r?this.Oo(r):void 0,o=this.Nn.get(i.id);o&&o.longPressTimer!==null&&(window.clearTimeout(o.longPressTimer),o.longPressTimer=null),this.Jn&&this.Jn(this.Ho(i,t,n,e)),o&&this.Xo(o,t),this.Nn.delete(i.id),this.In.delete(i.id),this.Gn.delete(i.id)}this.Gn.size<2&&(this.Xn=null)}Mo(t){if(!this.Or)return;t.preventDefault();const e=performance.now(),s=this.Lo(t.changedTouches);for(const i of s){const r=this.Gn.get(i.id),n=r?this.Oo(r):void 0,o=this.Nn.get(i.id);o&&o.longPressTimer!==null&&(window.clearTimeout(o.longPressTimer),o.longPressTimer=null),this.so&&this.so(this.Ho(i,t,n,e)),this.Nn.delete(i.id),this.In.delete(i.id),this.Gn.delete(i.id)}this.Gn.size<2&&(this.Xn=null)}Lo(t){const e=[];for(let s=0;s<t.length;s+=1){const i=t.item(s);i&&e.push(this.Wo(i))}return e}Wo(t){return this.Fo(t.clientX,t.clientY,t.identifier,{id:t.identifier,x:-1,y:-1,clientX:t.clientX,clientY:t.clientY,pressure:t.force,radiusX:t.radiusX,radiusY:t.radiusY,rotationAngle:t.rotationAngle})}Fo(t,e,s,i){const r=this.er.canvas,n=r.getBoundingClientRect(),o=t-n.left,l=e-n.top,c=r.width/n.width,g=l*(r.height/n.height),f=o*c-this.Or.offsetX,m=g-this.Or.offsetY,p=Math.floor(f/this.Or.cellWidth),d=Math.floor(m/this.Or.cellHeight),u=p>=0&&p<this.Or.cols&&d>=0&&d<this.Or.rows;return{id:s,x:u?p:-1,y:u?d:-1,clientX:t,clientY:e,pressure:i.pressure,radiusX:i.radiusX,radiusY:i.radiusY,rotationAngle:i.rotationAngle}}Ho(t,e,s,i){const r=this.Nn.get(t.id),n=Array.from(this.In.values()).map(c=>this.Oo(c)),o=Array.from(this.Gn.values()).map(c=>this.Oo(c)),l=this.Lo(e.changedTouches);return{touch:this.Oo(t),previousTouch:s?this.Oo(s):void 0,touches:o,previousTouches:n,changedTouches:l,deltaTime:r?i-r.lastTime:0,originalEvent:e}}Go(){if(this.Gn.size!==2)return void(this.Xn=null);const t=Array.from(this.Gn.values()),[e,s]=t,i=this.Io(e,s,!1),r=this.Ko(e,s);this.Xn={ids:[e.id,s.id],initialDistance:Math.max(i,1e-4),initialAngle:r,lastScale:1,lastRotation:0}}No(t){if(this.Xn||this.Go(),!this.Xn)return;const[e,s]=this.Xn.ids,i=this.Gn.get(e),r=this.Gn.get(s);if(!i||!r)return;const n=this.Io(i,r,!1)/this.Xn.initialDistance,o=n-this.Xn.lastScale;this.oo&&Math.abs(o)>this._o&&(this.oo({touches:[this.Oo(i),this.Oo(r)],scale:n,deltaScale:o,center:this.jo(i,r),originalEvent:t}),this.Xn.lastScale=n);let l=this.Ko(i,r)-this.Xn.initialAngle;l=(l+180)%360-180;const c=l-this.Xn.lastRotation;this.ho&&Math.abs(c)>this.mo&&(this.ho({touches:[this.Oo(i),this.Oo(r)],rotation:l,deltaRotation:c,center:this.jo(i,r),originalEvent:t}),this.Xn.lastRotation=l)}jo(t,e){const s=(t.clientX+e.clientX)/2,i=(t.clientY+e.clientY)/2,r=this.Fo(s,i,-1,{id:-1,x:-1,y:-1,clientX:s,clientY:i});return{x:r.x,y:r.y}}Xo(t,e){const s=performance.now(),i=s-t.startTime,r=this.Io(t.startPosition,t.lastPosition,!0);if(!t.longPressFired&&i<=this.ao&&r<=this.lo)this.Yo(t.lastPosition,s)&&this.io?this.io({touch:this.Oo(t.lastPosition),taps:2,originalEvent:e}):this.eo&&this.eo({touch:this.Oo(t.lastPosition),taps:1,originalEvent:e});else if(!t.longPressFired&&i<=this.po&&r>=this.do){const n={x:t.lastPosition.clientX-t.startPosition.clientX,y:t.lastPosition.clientY-t.startPosition.clientY},o=Math.max(Math.hypot(n.x,n.y),1e-4),l={x:n.x/o,y:n.y/o},c={x:n.x/i,y:n.y/i};this.no&&this.no({touch:this.Oo(t.lastPosition),direction:l,distance:o,velocity:c,originalEvent:e})}this.Ao=s,this.yo=this.Oo(t.lastPosition)}Yo(t,e){return!this.yo||e-this.Ao>this.co?!1:this.Io(t,this.yo,!0)<=this.lo}Oo(t){return{...t}}Io(t,e,s){return s?Math.hypot(t.clientX-e.clientX,t.clientY-e.clientY):Math.hypot(t.x-e.x,t.y-e.y)}Ko(t,e){return 180*Math.atan2(e.clientY-t.clientY,e.clientX-t.clientX)/Math.PI}}const qt=Object.freeze(Object.defineProperty({__proto__:null,TouchManager:ot},Symbol.toStringTag,{value:"Module"})),Kt=a=>class extends a{rotate(t=0,e=0,s=0){this.xt.state.st(t),this.xt.state.et(e),this.xt.state.it(s)}rotateX(t){this.xt.state.st(t)}rotateY(t){this.xt.state.et(t)}rotateZ(t){this.xt.state.it(t)}push(){this.xt.state.G()}pop(){this.xt.state.Z()}rect(t,e,s=1,i=1){this.xt.Ne(t,e,s,i)}point(t,e){this.xt.Ne(t,e,1,1)}line(t,e,s,i){this.xt.Xe(t,e,s,i)}lineWeight(t){this.xt.state.tt(t)}background(t,e=t,s=t,i=255){this.xt.qe(t,e,s,i)}char(t){this.xt.state.rt(this.$i.Pi(t))}charColor(t,e,s,i=255){this.xt.state.nt(t,e,s,i)}cellColor(t,e,s,i=255){this.xt.state.ot(t,e,s,i)}flipX(t){this.xt.state.ht(t)}flipY(t){this.xt.state.ct(t)}charRotation(t){this.xt.state.ut(t)}invert(t){this.xt.state.lt(t)}clear(){this.xt.qe(0,0,0,0)}ellipse(t,e,s,i){this.xt.We(t,e,s/2,i/2)}triangle(t,e,s,i,r,n){this.xt.Ke(t,e,s,i,r,n)}bezierCurve(t,e,s,i,r,n,o,l){this.xt.je(t,e,s,i,r,n,o,l)}arc(t,e,s,i,r,n){this.xt.Ve(t,e,s,i,r,n)}shader(t){this.xt.Be(t)}setUniform(t,e){this.xt.Kt(t,e)}setUniforms(t){this.xt.Le(t)}createFilterShader(t){return this.xt.hs(t)}createFramebuffer(t){return this.xt.Ye(t.width,t.height,5,{filter:"nearest",wrap:"clamp",format:"rgba",type:"unsigned_byte"})}image(t,e,s,i,r){if(t.textures){const n=t;this.xt.Oe(n,e,s,i??n.width,r??n.height)}else{const n=t;this.xt.He(n,e,s,i??Math.floor(this.Or.cols/2),r??Math.floor(this.Or.rows/2))}}async loadImage(t){if(typeof t!="string")return H.zr(this.xt,t,i=>this.$i.Si(i));const e=t,s=await new Promise((i,r)=>{const n=new Image;n.crossOrigin="anonymous",n.onload=()=>i(n),n.onerror=o=>r(o),n.src=e});return H.zr(this.xt,s,i=>this.$i.Si(i))}},jt=a=>class extends a{async loadFont(t){return this.$i.qi(t).then(()=>{const e=this.$i.maxGlyphDimensions;this.Or.hr(e.width,e.height),this.Vo.resize(this.Or.cols,this.Or.rows),this.xt.Ze(),this.Hn.hn()})}fontSize(t){if(!z.v(typeof t=="number"&&t>0,"Font size must be a positive number greater than 0.",{method:"fontSize",providedValue:t})||this.$i.fontSize===t)return;this.$i.Vi(t);const e=this.$i.maxGlyphDimensions;this.Or.hr(e.width,e.height),this.Vo.resize(this.Or.cols,this.Or.rows),this.xt.Ze(),this.Hn.hn()}glyphColor(t){return this.$i.Pi(t)}glyphColors(t){return this.$i.Si(t)}},Zt=a=>class extends a{get frameCount(){return this.qo.frameCount}set frameCount(t){this.qo.frameCount=t}frameRate(t){return t===void 0?this.qo.currentFrameRate:this.qo.frameRate(t,()=>this.Zo())}noLoop(){this.qo.pause()}loop(){this.qo.resume(()=>this.Zo())}redraw(t=1){if(z.v(typeof t=="number"&&t>0&&Number.isInteger(t),"Redraw count must be a positive integer.",{method:"redraw",providedValue:t}))for(let e=0;e<t;e++)this.Zo()}isLooping(){return this.qo.isLooping}},Qt=a=>class extends a{constructor(...t){super(...t)}mouseClicked(t){this.Hn.mn(t)}mousePressed(t){this.Hn.vn(t)}mouseReleased(t){this.Hn.gn(t)}mouseMoved(t){this.Hn.An(t)}mouseScrolled(t){this.Hn.yn(t)}get mouse(){return this.Hn.wn()}cursor(t){this.Hn.nn(t)}},Jt=a=>class extends a{constructor(...t){super(...t)}touchStarted(t){this.Qo.Ro(t)}touchMoved(t){this.Qo.An(t)}touchEnded(t){this.Qo.To(t)}touchCancelled(t){this.Qo.Po(t)}tap(t){this.Qo.So(t)}doubleTap(t){this.Qo.$o(t)}longPress(t){this.Qo.Eo(t)}swipe(t){this.Qo.Do(t)}pinch(t){this.Qo.ko(t)}rotateGesture(t){this.Qo.Bo(t)}get touches(){return this.Qo.zo()}},$t=a=>class extends a{constructor(...t){super(...t)}keyPressed(t){this.Jo.vn(t)}keyReleased(t){this.Jo.gn(t)}isKeyPressed(t){return this.Jo.$n(t)}get lastKeyPressed(){return this.Jo.Dn()}get lastKeyReleased(){return this.Jo.kn()}get pressedKeys(){return this.Jo.Bn()}get modifierState(){return this.Jo.Ln()}};class te{constructor(t){h(this,"th"),h(this,"sh",new Map),h(this,"eh",[]),h(this,"ih",new Map),h(this,"rh",new Map),this.th=t}async nh(t){for(const e of t){if(this.sh.has(e.name))return void console.warn(`[textmode.js] Plugin "${e.name}" is already installed.`);const s=this.oh(e.name);try{await e.install(this.th,s)}catch(i){throw this.hh(e.name),i}this.sh.set(e.name,e),this.eh.push(e.name)}}async ah(t){const e=this.sh.get(t);if(!e)return;const s=this.oh(t);if(e.uninstall)try{await e.uninstall(this.th,s)}catch(i){console.error(`[textmode.js] Error while uninstalling plugin "${t}":`,i)}this.sh.delete(t),this.eh.splice(this.eh.indexOf(t),1),this.hh(t)}runPreDrawHooks(){this.uh(this.ih,"preDraw")}runPostDrawHooks(){this.uh(this.rh,"postDraw")}async fh(){const t=[...this.sh.keys()];for(const e of t)await this.ah(e)}oh(t){return{...this.th.dh(),registerPreDrawHook:e=>this.ph(this.ih,t,e),registerPostDrawHook:e=>this.ph(this.rh,t,e)}}ph(t,e,s){const i=t.get(e)??new Set;return i.add(s),t.set(e,i),()=>{const r=t.get(e);r&&(r.delete(s),r.size===0&&t.delete(e))}}hh(t){this.ih.delete(t),this.rh.delete(t)}uh(t,e){for(const s of this.eh){const i=t.get(s);if(i)for(const r of i)try{r()}catch(n){console.error(`[textmode.js] Plugin "${s}" ${e} hook failed:`,n)}}}}class ee{constructor(){h(this,"xt"),h(this,"$i"),h(this,"er"),h(this,"Or"),h(this,"qo"),h(this,"Hn"),h(this,"Qo"),h(this,"Jo"),h(this,"_h"),h(this,"Vo"),h(this,"mh"),h(this,"gh"),h(this,"Ah")}Zo(){}}class se extends function(t,...e){return e.reduce((s,i)=>i(s),t)}(ee,Kt,jt,Zt,Qt,Jt,$t){constructor(t={}){super(),h(this,"yh"),h(this,"wh",!1),h(this,"Ch",()=>{}),h(this,"bh",()=>{}),h(this,"xh",()=>{}),h(this,"Mh"),h(this,"lr"),h(this,"cr",!1),h(this,"Fh"),this.yh=new te(this),this.cr=t.overlay??!1,this.er=new Yt(t),this.xt=new Ft(this.er.gr()),this.$i=new Gt(this.xt,t.fontSize??16),this.qo=new Wt(t.frameRate??60),this.Hn=new rt(this.er),this.Qo=new ot(this.er,this.Hn),this.Jo=new nt,this._h=this.xt.Pt(),this.mh=this.xt.rs(),this.zh(t)}async zh(t){await this.$i.Ki(t.fontSource);const e=this.$i.maxGlyphDimensions;this.Or=new Xt(this.er.canvas,e.width,e.height),this.Hn.Ki(this.Or),this.Qo.Ki(this.Or),this.Vo=this.xt.Ye(this.Or.cols,this.Or.rows,5),this.gh=this.xt.Ye(this.Or.width,this.Or.height,1),this.cr&&(this.Fh=H.zr(this.xt,this.er.targetCanvas,s=>this.$i.Si(s))),this.Ah=this.xt.cs(it,"precision mediump float;uniform sampler2D Ua;uniform vec2 Ub;uniform vec2 Uc;uniform vec2 Ud;void main(){vec2 A=gl_FragCoord.xy-Uc;vec2 B=A*(Ub/Ud);vec2 C=(floor(B)+0.5)/Ub;gl_FragColor=texture2D(Ua,C);}"),this.Rh(),await this.yh.nh(t.plugins??[]),this.Ch(),this.qo.start(()=>this.Zo())}dh(){return{renderer:this.xt,font:this.$i,grid:this.Or,canvas:this.er,drawFramebuffer:this.Vo,asciiFramebuffer:this.gh,flushDrawCommands:()=>{this.xt.St(this._h)}}}Rh(){this.Mh=()=>{this.cr&&this.resizeCanvas(this.er.targetCanvas.width,this.er.targetCanvas.height),this.xh()},window.addEventListener("resize",this.Mh),this.Hn.an(),this.Qo.an(),this.Jo.an(),window.addEventListener("blur",()=>{this.Jo.On()}),window.ResizeObserver&&this.cr&&(this.lr=new ResizeObserver(()=>{this.resizeCanvas(this.er.targetCanvas.width,this.er.targetCanvas.height)}),this.lr.observe(this.er.targetCanvas))}Zo(){if(this.qo.measureFrameRate(),this.qo.incrementFrame(),this.wh)return;if(this.cr){const e=this.xt.context;e.bindTexture(e.TEXTURE_2D,this.Fh.texture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.er.targetCanvas),e.bindTexture(e.TEXTURE_2D,null)}this.yh.runPreDrawHooks(),this.Vo.begin(),this.xt.ke(this._h),this.bh(),this.xt.St(this._h),this.Vo.end(),this.gh.begin(),this.xt.ke(this.mh),this.mh.Wt({U0:this.$i.fontFramebuffer,U1:[this.$i.textureColumns,this.$i.textureRows],U2:this.Vo.textures[0],U3:this.Vo.textures[1],U4:this.Vo.textures[2],U5:this.Vo.textures[4],U6:this.Vo.textures[3],U7:[this.Or.cols,this.Or.rows],U8:[this.gh.width,this.gh.height],U9:this.gh.width/this.gh.height}),this.xt.Ie(0,0,this.er.width,this.er.height),this.gh.end();const t=this.xt.state.canvasBackgroundColor;this.xt.Ys(t[0],t[1],t[2],t[3]),this.xt.ke(this.Ah),this.Ah.Wt({Ua:this.gh.textures[0],Ub:[this.gh.width,this.gh.height],Uc:[this.Or.offsetX,this.Or.offsetY],Ud:[this.Or.width,this.Or.height]}),this.xt.Ie(this.Or.offsetX,this.Or.offsetY,this.Or.width,this.Or.height),this.yh.runPostDrawHooks()}setup(t){this.Ch=t}draw(t){this.bh=t}windowResized(t){this.xh=t}resizeCanvas(t,e){this.er.vr(t,e),this.Or.nr(),this.Vo.resize(this.Or.cols,this.Or.rows),this.gh.resize(this.Or.width,this.Or.height),this.xt.Ze(),this.Hn.hn(),this.Qo.wo(),this.Zo()}destroy(){this.wh||(this.qo.stop(),this.yh.fh().catch(t=>{console.error("[textmode.js] Error while disposing plugins:",t)}),window.removeEventListener("resize",this.Mh),this.Hn._n(),this.Qo._n(),this.Jo._n(),this.$i.Dt(),this.xt.Dt(),this.gh.Dt(),this.Ah.Dt(),this.Fh&&this.Fh.Dt(),this.wh=!0)}get grid(){return this.Or}get font(){return this.$i}get width(){return this.er.width}get height(){return this.er.height}get canvas(){return this.er.canvas}get drawFramebuffer(){return this.Vo}get isDisposed(){return this.wh}get overlay(){return this.Fh}}class re{constructor(){}static create(t={}){return new se(t)}static setErrorLevel(t){z.A(t)}static get version(){return"0.4.0"}}Object.freeze(Object.defineProperty({__proto__:null,keyboard:Vt,mouse:kt,touch:qt},Symbol.toStringTag,{value:"Module"}));export{re as Q};
